# 批量执行功能 - 前端实现指南

## 概述

本文档说明如何在前端实现批量执行功能。后端API已经完成，前端需要添加用户界面来调用这些API。

## 后端API接口

### 1. 接口自动化

```typescript
// 批量执行
POST /engine-service/api/v1/api_case/batch_execute
Body: {
  projectId: number
  caseIds: number[]
  moduleId?: number
}

// 按模块执行
POST /engine-service/api/v1/api_case/execute_by_module?projectId=xxx&moduleId=xxx
```

### 2. UI自动化

```typescript
// 批量执行
POST /engine-service/api/v1/ui_case/batch_execute
Body: {
  projectId: number
  caseIds: number[]
  moduleId?: number
}

// 按模块执行
POST /engine-service/api/v1/ui_case/execute_by_module?projectId=xxx&moduleId=xxx
```

### 3. 压测

```typescript
// 批量执行
POST /engine-service/api/v1/stress_case/batch_execute
Body: {
  projectId: number
  caseIds: number[]
  moduleId?: number
}

// 按模块执行
POST /engine-service/api/v1/stress_case/execute_by_module?projectId=xxx&moduleId=xxx
```

## 前端实现方案

### 方案1：修改TableModal组件（推荐）

TableModal是通用组件，建议在其中添加批量操作功能的支持。

#### 1.1 修改 `frontend/src/components/TableModal.vue`

**添加props:**

```typescript
const props = withDefaults(
  defineProps<{
    // ...existing props
    enableBatchExecution?: boolean  // 是否启用批量执行
  }>(),
  {
    enableBatchExecution: false,  // 默认不启用
  },
)
```

**添加状态:**

```typescript
// 批量选择相关
const selectedRowKeys = ref<number[]>([])
const batchExecuting = ref(false)

// 表格行选择配置
const rowSelection = computed(() => {
  if (!props.enableBatchExecution) return undefined
  
  return {
    selectedRowKeys: selectedRowKeys.value,
    onChange: (keys: number[]) => {
      selectedRowKeys.value = keys
    },
  }
})
```

**添加批量执行方法:**

```typescript
// 批量执行
async function handleBatchExecute() {
  if (selectedRowKeys.value.length === 0) {
    message.warning('请先选择要执行的用例')
    return
  }

  try {
    batchExecuting.value = true
    
    const { data } = await useCustomFetch(
      `/engine-service/api/v1/${baseName.value}/batch_execute`,
      {
        method: 'POST',
        body: {
          projectId: globalConfigStore.selectedProjectId,
          caseIds: selectedRowKeys.value,
        },
      },
    ).execute()

    if (data.value?.code === 0) {
      const summary = data.value.data
      message.success(
        `批量执行完成：总数 ${summary.total}，成功 ${summary.success}，失败 ${summary.fail}`,
      )
      selectedRowKeys.value = []
    } else {
      message.error(data.value?.msg || '批量执行失败')
    }
  } catch (error) {
    message.error('批量执行异常')
    console.error(error)
  } finally {
    batchExecuting.value = false
  }
}

// 按模块执行
async function handleExecuteByModule() {
  if (selectedModuleId.value === -1) {
    message.warning('请先选择模块')
    return
  }

  try {
    batchExecuting.value = true
    
    const { data } = await useCustomFetch(
      `/engine-service/api/v1/${baseName.value}/execute_by_module`,
      {
        method: 'POST',
        params: {
          projectId: globalConfigStore.selectedProjectId,
          moduleId: selectedModuleId.value,
        },
      },
    ).execute()

    if (data.value?.code === 0) {
      const summary = data.value.data
      message.success(
        `模块执行完成：总数 ${summary.total}，成功 ${summary.success}，失败 ${summary.fail}`,
      )
    } else {
      message.error(data.value?.msg || '模块执行失败')
    }
  } catch (error) {
    message.error('模块执行异常')
    console.error(error)
  } finally {
    batchExecuting.value = false
  }
}
```

**修改模板:**

```vue
<template>
  <div class="table-container">
    <!-- 批量操作工具栏 -->
    <div v-if="enableBatchExecution" class="batch-toolbar">
      <span class="selected-count">
        已选择 {{ selectedRowKeys.length }} 项
      </span>
      <a-space>
        <a-button 
          type="primary" 
          :disabled="selectedRowKeys.length === 0"
          :loading="batchExecuting"
          @click="handleBatchExecute"
        >
          批量执行
        </a-button>
        <a-button 
          :loading="batchExecuting"
          @click="handleExecuteByModule"
        >
          执行当前模块
        </a-button>
        <a-button 
          v-if="selectedRowKeys.length > 0"
          @click="selectedRowKeys = []"
        >
          清空选择
        </a-button>
      </a-space>
    </div>

    <!-- 表格 -->
    <a-table
      :row-selection="rowSelection"
      :columns="columns"
      :data-source="tableDataSource"
      :loading="loadingWithGetTableDataSource"
      <!-- ...其他props -->
    >
      <!-- ...existing slots -->
    </a-table>
  </div>
</template>

<style scoped>
.batch-toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  background: #fafafa;
  border: 1px solid #d9d9d9;
  border-bottom: none;
  border-radius: 4px 4px 0 0;
}

.selected-count {
  color: #1890ff;
  font-weight: 500;
}
</style>
```

#### 1.2 修改各用例列表页面

在各个用例列表页面（接口/UI/压测）中启用批量执行功能：

**`frontend/src/views/interface-automation/case/index.vue`:**

```vue
<template>
  <!-- ...existing code -->
  
  <TableModal 
    base-name="api_case" 
    localized-name="接口用例" 
    :columns="columns"
    :enable-batch-execution="true"
  >
    <!-- ...existing slots -->
  </TableModal>
</template>
```

**`frontend/src/views/ui-automation/case/index.vue`:**

```vue
<template>
  <TableModal 
    base-name="ui_case" 
    localized-name="UI用例" 
    :columns="columns"
    :enable-batch-execution="true"
  >
    <!-- ...existing slots -->
  </TableModal>
</template>
```

**`frontend/src/views/stress-test/manager/index.vue`:**

```vue
<template>
  <TableModal 
    base-name="stress_case" 
    localized-name="压测用例" 
    :columns="columns"
    :enable-batch-execution="true"
  >
    <!-- ...existing slots -->
  </TableModal>
</template>
```

### 方案2：独立实现（备选）

如果不想修改TableModal组件，可以在各个页面中独立实现批量执行功能。

参考实现：

```vue
<script lang="ts" setup>
import { ref } from 'vue'
import { message } from 'ant-design-vue'

// 批量选择相关
const selectedRowKeys = ref<number[]>([])

const rowSelection = {
  selectedRowKeys: selectedRowKeys.value,
  onChange: (keys: number[]) => {
    selectedRowKeys.value = keys
  },
}

// 批量执行
async function handleBatchExecute() {
  // 实现逻辑同方案1
}
</script>

<template>
  <!-- 自定义工具栏 -->
  <div class="custom-toolbar">
    <a-button 
      type="primary" 
      @click="handleBatchExecute"
    >
      批量执行 ({{ selectedRowKeys.length }})
    </a-button>
  </div>

  <!-- 表格 -->
  <TableModal 
    :row-selection="rowSelection"
    <!-- ...other props -->
  />
</template>
```

## 用户体验优化建议

### 1. 执行结果展示

批量执行完成后，建议弹出模态框显示详细结果：

```typescript
// 批量执行结果模态框
const batchResultVisible = ref(false)
const batchResultData = ref<any>(null)

function showBatchResult(data: any) {
  batchResultData.value = data
  batchResultVisible.value = true
}
```

```vue
<a-modal
  v-model:visible="batchResultVisible"
  title="批量执行结果"
  width="800px"
>
  <a-descriptions :column="3">
    <a-descriptions-item label="总数">
      {{ batchResultData?.total }}
    </a-descriptions-item>
    <a-descriptions-item label="成功">
      <span style="color: #52c41a">
        {{ batchResultData?.success }}
      </span>
    </a-descriptions-item>
    <a-descriptions-item label="失败">
      <span style="color: #ff4d4f">
        {{ batchResultData?.fail }}
      </span>
    </a-descriptions-item>
  </a-descriptions>

  <a-table
    :columns="resultColumns"
    :data-source="batchResultData?.results"
    :pagination="false"
    style="margin-top: 16px"
  >
    <template #bodyCell="{ column, record }">
      <template v-if="column.key === 'success'">
        <a-tag :color="record.success ? 'success' : 'error'">
          {{ record.success ? '成功' : '失败' }}
        </a-tag>
      </template>
    </template>
  </a-table>
</a-modal>
```

### 2. 执行进度提示

对于大批量执行，可以显示进度条：

```typescript
import { notification } from 'ant-design-vue'

// 显示执行进度
notification.info({
  message: '批量执行中',
  description: `正在执行 ${selectedRowKeys.value.length} 个用例，请稍候...`,
  duration: 0,  // 不自动关闭
  key: 'batch-executing',
})

// 执行完成后关闭
notification.close('batch-executing')
```

### 3. 快捷键支持

```typescript
// 全选快捷键
onKeyStroke('KeyA', (e) => {
  if (e.ctrlKey || e.metaKey) {
    e.preventDefault()
    selectedRowKeys.value = tableDataSource.value.map(item => item.id)
  }
})

// 执行快捷键
onKeyStroke('Enter', (e) => {
  if ((e.ctrlKey || e.metaKey) && selectedRowKeys.value.length > 0) {
    e.preventDefault()
    handleBatchExecute()
  }
})
```

## 测试建议

### 1. 功能测试

- [ ] 勾选用例后，"批量执行"按钮可点击
- [ ] 未勾选用例时，"批量执行"按钮禁用
- [ ] 批量执行成功后，显示正确的成功/失败统计
- [ ] 按模块执行功能正常工作
- [ ] 清空选择功能正常工作

### 2. 边界测试

- [ ] 选择0个用例时提示用户
- [ ] 选择1个用例时正常执行
- [ ] 选择大量用例（如100个）时不卡顿
- [ ] 执行过程中切换模块不会出错
- [ ] 执行过程中关闭页面不会导致问题

### 3. 异常测试

- [ ] 后端返回错误时，前端正确提示
- [ ] 网络异常时，前端正确处理
- [ ] 部分用例执行失败时，显示详细信息

## 实施优先级

### P0（立即实现）
- TableModal组件添加批量选择功能
- 批量执行按钮和API调用
- 基本的成功/失败提示

### P1（短期实现）
- 执行结果详情模态框
- 按模块执行功能
- 清空选择功能

### P2（长期优化）
- 执行进度提示
- 快捷键支持
- 高级筛选和排序

## 总结

批量执行功能的核心是：
1. 添加表格行选择功能（row-selection）
2. 调用后端批量执行API
3. 显示执行结果

建议采用**方案1（修改TableModal组件）**，这样可以让所有使用TableModal的页面都能方便地启用批量执行功能，代码复用性更好。

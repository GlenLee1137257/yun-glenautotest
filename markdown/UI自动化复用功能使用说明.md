# UI自动化复用功能使用说明

> **文档版本**: v1.0  
> **更新日期**: 2026年1月22日  
> **功能说明**: UI自动化测试中的步骤复用功能

---

## 一、功能概述

### 1.1 什么是步骤复用？

UI自动化步骤复用功能允许你在一个UI用例中**引用其他用例的步骤**，实现步骤的复用和共享，避免重复配置相同的操作步骤。

### 1.2 使用场景

**典型场景**：
- **登录步骤复用**：多个用例都需要先登录，可以创建一个"登录"用例，其他用例引用其登录步骤
- **公共操作复用**：如"返回首页"、"打开菜单"等公共操作，可以在多个用例中复用
- **复杂操作复用**：一些复杂的操作流程（如"添加商品到购物车"），可以在多个用例中复用

**优势**：
- ✅ 减少重复配置，提高效率
- ✅ 统一管理公共步骤，修改一处即可影响所有引用
- ✅ 降低维护成本

---

## 二、步骤类型说明

### 2.1 步骤类型

UI自动化支持两种步骤类型：

| 步骤类型 | 说明 | 使用场景 |
|---------|------|---------|
| **LOCAL** | 本地步骤 | 当前用例中直接配置的操作步骤 |
| **REFER** | 引用步骤 | 引用其他用例中的步骤 |

### 2.2 步骤类型选择

在创建或编辑UI用例步骤时，可以选择步骤类型：

- **LOCAL（本地步骤）**：需要配置完整的操作信息（操作类型、元素定位、值等）
- **REFER（引用步骤）**：只需要选择要引用的步骤ID，系统会自动使用被引用步骤的所有配置

---

## 三、如何使用步骤复用

### 3.1 创建被引用的步骤（基础步骤）

**步骤1：创建基础用例**

1. 进入 `UI自动化` → `用例管理`
2. 创建一个用例，例如：`登录操作`
3. 在该用例中添加步骤，例如：
   - 步骤1：打开登录页面
   - 步骤2：输入用户名
   - 步骤3：输入密码
   - 步骤4：点击登录按钮

**步骤2：记录步骤ID**

- 保存用例后，每个步骤都会有一个唯一的ID
- 在步骤列表中可以看到步骤ID，或者在编辑步骤时查看

### 3.2 在其他用例中引用步骤

**步骤1：创建新用例**

1. 进入 `UI自动化` → `用例管理`
2. 创建新用例，例如：`下单流程测试`

**步骤2：添加引用步骤**

1. 点击 `+` 添加新步骤
2. 在步骤配置中，选择 **步骤类型** 为 `REFER（引用步骤）`
3. 在 **引用步骤** 下拉框中选择要引用的步骤
4. （可选）自定义步骤名称，如果不填写，将使用被引用步骤的名称

**步骤3：配置其他步骤**

- 可以混合使用 LOCAL 和 REFER 类型的步骤
- 例如：
  - 步骤1：REFER - 引用"登录"步骤
  - 步骤2：LOCAL - 打开商品详情页
  - 步骤3：REFER - 引用"添加到购物车"步骤
  - 步骤4：LOCAL - 提交订单

---

## 四、功能特性

### 4.1 循环引用检测

系统会自动检测循环引用，防止以下情况：
- A步骤引用B步骤，B步骤又引用A步骤
- 多层循环引用（A→B→C→A）

如果检测到循环引用，系统会抛出异常，防止无限递归。

### 4.2 步骤信息保留

引用步骤时：
- **保留的信息**：当前步骤的ID、序号（num）、自定义名称
- **使用被引用步骤的信息**：操作类型、元素定位、值、断言等所有操作配置

### 4.3 步骤名称自定义

- 如果引用步骤时设置了自定义名称，将使用自定义名称
- 如果未设置自定义名称，将使用被引用步骤的原始名称

---

## 五、使用示例

### 5.1 示例场景：登录步骤复用

**场景描述**：
- 有多个测试用例都需要先登录
- 登录步骤包含：打开登录页、输入用户名、输入密码、点击登录

**实现步骤**：

#### 步骤1：创建"登录"用例

1. 创建用例：`登录操作`
2. 添加步骤：
   - 步骤1：打开登录页面（LOCAL）
   - 步骤2：输入用户名（LOCAL）
   - 步骤3：输入密码（LOCAL）
   - 步骤4：点击登录按钮（LOCAL）

#### 步骤2：在其他用例中引用

1. 创建用例：`商品浏览测试`
2. 添加步骤：
   - 步骤1：REFER - 引用"登录操作"用例的"打开登录页面"步骤
   - 步骤2：REFER - 引用"登录操作"用例的"输入用户名"步骤
   - 步骤3：REFER - 引用"登录操作"用例的"输入密码"步骤
   - 步骤4：REFER - 引用"登录操作"用例的"点击登录按钮"步骤
   - 步骤5：LOCAL - 浏览商品列表
   - 步骤6：LOCAL - 查看商品详情

**优势**：
- 如果登录页面URL或元素定位发生变化，只需修改"登录操作"用例
- 所有引用该步骤的用例都会自动使用新的配置

### 5.2 示例场景：公共操作复用

**场景描述**：
- 多个用例都需要"返回首页"操作

**实现步骤**：

1. 在某个用例中创建"返回首页"步骤（LOCAL类型）
2. 在其他用例中引用该步骤（REFER类型）

---

## 六、注意事项

### 6.1 引用步骤的限制

1. **只能引用同一项目下的步骤**
   - 不能跨项目引用步骤
   - 确保被引用的步骤在当前项目下存在

2. **被引用的步骤不能删除**
   - 如果删除被引用的步骤，引用该步骤的用例执行时会报错
   - 删除步骤前，需要先检查是否有其他步骤引用了它

3. **步骤ID必须有效**
   - 引用步骤时必须提供有效的 `referStepId`
   - 如果步骤ID不存在，执行时会抛出异常

### 6.2 最佳实践

1. **创建公共步骤用例**
   - 建议创建一个专门的用例存放公共步骤（如登录、返回首页等）
   - 方便管理和维护

2. **步骤命名规范**
   - 被引用的步骤使用清晰的名称，如"登录-输入用户名"
   - 引用步骤时可以自定义名称，便于理解

3. **避免过度引用**
   - 虽然支持多层引用，但建议控制在2-3层以内
   - 过度引用会增加调试难度

4. **定期检查引用关系**
   - 定期检查被引用步骤是否仍然有效
   - 修改被引用步骤时，注意对引用它的用例的影响

---

## 七、技术实现

### 7.1 数据库字段

UI用例步骤表（`glen_ui.ui_case_step`）包含以下字段：

- `step_type`：步骤类型（LOCAL / REFER）
- `refer_step_id`：引用步骤ID（当 step_type=REFER 时有效）

### 7.2 执行流程

```
执行UI用例
    ↓
遍历用例步骤
    ↓
判断步骤类型
    ├→ LOCAL: 直接执行步骤操作
    └→ REFER: 
        ├→ 根据referStepId查找被引用步骤
        ├→ 检测循环引用
        ├→ 使用被引用步骤的操作配置
        └→ 执行步骤操作
```

### 7.3 循环引用检测

系统使用 `Set<Long> visitedStepIds` 记录已访问的步骤ID，防止循环引用：

```java
// 如果步骤A引用步骤B，步骤B引用步骤C，步骤C又引用步骤A
// 系统会检测到循环引用并抛出异常
```

---

## 八、常见问题

### Q1: 引用步骤后，执行时报错"引用步骤的referStepId不能为空"

**原因**：选择了REFER类型，但没有选择要引用的步骤ID

**解决**：在"引用步骤"下拉框中选择一个有效的步骤

### Q2: 执行时报错"循环引用"

**原因**：存在循环引用关系（A引用B，B引用A）

**解决**：检查步骤的引用关系，消除循环引用

### Q3: 执行时报错"被引用的步骤不存在"

**原因**：引用的步骤ID对应的步骤已被删除或不存在

**解决**：检查被引用的步骤是否存在，如果不存在，需要重新选择或创建

### Q4: 如何查看哪些用例引用了某个步骤？

**当前限制**：系统暂不支持反向查询（查看某个步骤被哪些用例引用）

**建议**：
- 使用清晰的步骤命名，便于识别
- 在用例描述中记录引用的步骤信息

---

## 九、与接口自动化的对比

| 特性 | UI自动化复用 | 接口自动化复用 |
|------|------------|--------------|
| 支持情况 | ✅ 支持 | ❌ 暂不支持 |
| 复用粒度 | 步骤级别 | - |
| 引用方式 | 通过步骤ID引用 | - |
| 循环引用检测 | ✅ 支持 | - |

---

## 十、总结

UI自动化步骤复用功能是一个强大的特性，可以：

- ✅ 提高用例编写效率
- ✅ 减少重复配置
- ✅ 统一管理公共操作
- ✅ 降低维护成本

**推荐使用场景**：
- 登录、登出等公共操作
- 导航、菜单操作
- 复杂的业务流程步骤

**注意事项**：
- 避免循环引用
- 确保被引用步骤的有效性
- 合理使用，不要过度引用

---

**文档位置**: `/home/hinkad/yun-glenautotest/markdown/UI自动化复用功能使用说明.md`  
**最后更新**: 2026-01-22

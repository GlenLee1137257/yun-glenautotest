# Glen 自动化测试平台 - 运维手册

本文档描述了服务器重启后的恢复操作以及常用运维命令。

---

## 一、服务器重启后服务恢复步骤

### 1.1 一键启动所有服务（推荐）

项目提供了 `restart-all.sh` 脚本，可以一键启动所有服务（中间件、后端、前端）。

```bash
# 进入项目目录
cd /opt/yun-glenautotest

# 执行启动脚本
./restart-all.sh
```

**脚本执行流程：**
1. 创建日志目录 `backend/logs`
2. 启动 Docker 中间件（MySQL、Redis、Nacos、Kafka、MinIO）
3. 等待 15 秒让中间件就绪
4. 依次启动 4 个后端服务（gateway、account、engine、data）
5. 启动前端服务

**日志位置：**
- Gateway:  `/opt/yun-glenautotest/backend/logs/gateway.log`
- Account:  `/opt/yun-glenautotest/backend/logs/account.log`
- Engine:   `/opt/yun-glenautotest/backend/logs/engine.log`
- Data:     `/opt/yun-glenautotest/backend/logs/data.log`
- Frontend: `/opt/yun-glenautotest/backend/logs/frontend.log`

### 1.2 中间件服务恢复

中间件使用 Docker 部署，配置了 `restart: always`，服务器重启后会**自动启动**。

如果需要手动启动，执行以下命令：

```bash
# 进入项目目录
cd /opt/yun-glenautotest

# 启动所有 Docker 中间件服务
docker compose up -d
```

**中间件列表：**
- **MySQL**: 端口 3306
- **Redis**: 端口 6379
- **Nacos**: 端口 8848 (Console: http://localhost:8848/nacos)
- **Zookeeper**: 端口 2181
- **Kafka**: 端口 9092
- **MinIO**: 端口 9000 (Console: http://localhost:9001)

### 1.3 后端服务恢复（手动方式）

如果不想使用一键脚本，可以手动启动后端服务：

```bash
# 进入项目目录
cd /opt/yun-glenautotest/backend

# 启动 4 个后端服务（建议使用 nohup 或 screen）
nohup mvn -f glen-gateway spring-boot:run > logs/gateway.log 2>&1 &
nohup mvn -f glen-account spring-boot:run > logs/account.log 2>&1 &
nohup mvn -f glen-engine spring-boot:run > logs/engine.log 2>&1 &
nohup mvn -f glen-data spring-boot:run > logs/data.log 2>&1 &
```

**后端服务列表：**
- **glen-gateway**: 网关服务
- **glen-account**: 账户服务
- **glen-engine**: 测试引擎服务
- **glen-data**: 数据服务

### 1.4 前端服务恢复（手动方式）

如果不想使用一键脚本，可以手动启动前端服务：

```bash
# 进入前端目录
cd /opt/yun-glenautotest/frontend

# 启动前端服务
nohup pnpm run dev > /opt/yun-glenautotest/backend/logs/frontend.log 2>&1 &
```

---

## 二、查看服务器运行中的服务和中间件

### 2.1 查看 Docker 中间件状态

```bash
# 查看所有 Docker 容器状态
docker ps -a

# 查看运行中的 Docker 容器
docker ps

# 查看 docker-compose 服务状态
cd /opt/yun-glenautotest
docker compose ps
```

### 2.2 查看后端服务进程

```bash
# 查看所有 Java 进程
ps -ef | grep java

# 查看具体的 SpringBoot 服务进程
ps -ef | grep spring-boot:run

# 使用 jps 查看 Java 进程（如果安装了 JDK）
jps -l
```

### 2.3 查看前端服务进程

```bash
# 查看 Node.js / Vite 进程
ps -ef | grep node

# 查看 pnpm 进程
ps -ef | grep pnpm
```

### 2.4 查看端口占用情况

```bash
# 查看指定端口占用情况
netstat -tlnp | grep <端口号>

# 示例：查看 8848 端口（Nacos）
netstat -tlnp | grep 8848

# 查看 Docker 相关端口
netstat -tlnp | grep -E '3306|6379|8848|9092|9000'

# 查看所有监听端口
netstat -tlnp
```

### 2.5 查看系统资源使用情况

```bash
# 查看 CPU、内存使用情况
top

# 或使用 htop（更友好）
htop

# 查看磁盘使用情况
df -h

# 查看内存详细使用情况
free -h
```

---

## 三、后端服务日志查看

### 3.1 日志位置说明

如果使用 `restart-all.sh` 脚本启动服务，日志会被重定向到以下文件：

| 服务 | 日志文件路径 |
|------|-------------|
| glen-gateway | `/opt/yun-glenautotest/backend/logs/gateway.log` |
| glen-account | `/opt/yun-glenautotest/backend/logs/account.log` |
| glen-engine | `/opt/yun-glenautotest/backend/logs/engine.log` |
| glen-data | `/opt/yun-glenautotest/backend/logs/data.log` |
| frontend | `/opt/yun-glenautotest/backend/logs/frontend.log` |

### 3.2 日志查看命令

```bash
# 实时查看日志（tail -f）
tail -f /opt/yun-glenautotest/backend/logs/gateway.log
tail -f /opt/yun-glenautotest/backend/logs/account.log
tail -f /opt/yun-glenautotest/backend/logs/engine.log
tail -f /opt/yun-glenautotest/backend/logs/data.log
tail -f /opt/yun-glenautotest/backend/logs/frontend.log

# 查看最后 100 行
tail -n 100 /opt/yun-glenautotest/backend/logs/gateway.log

# 查看最后 500 行并分页
tail -n 500 /opt/yun-glenautotest/backend/logs/gateway.log | less

# 搜索关键字
grep "ERROR" /opt/yun-glenautotest/backend/logs/gateway.log
grep -i "error" /opt/yun-glenautotest/backend/logs/gateway.log
```

### 3.3 如果日志输出到控制台

如果服务没有重定向日志文件，可以通过进程查看输出：

```bash
# 馦先找到进程 PID
ps -ef | grep "glen-gateway"

# 假设 PID 为 1234，使用 journalctl 查看日志（如果是 systemd 服务）
journalctl -u <service-name> -f

# 使用 strace 追踪（需要 root）
strace -p <PID>

# 使用 /proc 查看进程信息
ls -la /proc/<PID>/fd/
```

### 3.4 Docker 中间件日志查看

```bash
# 查看某个容器日志
docker logs glen-mysql
docker logs glen-redis
docker logs glen-nacos
docker logs glen-zookeeper
docker logs glen-kafka
docker logs glen-minio

# 实时查看日志
docker logs -f glen-nacos

# 查看最后 100 行
docker logs --tail 100 glen-nacos
```

---

## 四、常用运维脚本

### 4.1 restart-all.sh - 一键启动所有服务

项目提供了一键启动脚本，可以快速启动所有服务。

**使用步骤：**

```bash
# 进入项目目录
cd /opt/yun-glenautotest

# 执行启动脚本
./restart-all.sh
```

**脚本执行过程：**

1. **启动 Docker 中间件**
   - MySQL、Redis、Nacos、Kafka、MinIO

2. **等待中间件就绪**
   - 等待 15 秒让中间件完全启动

3. **启动后端服务**
   - glen-gateway（网关服务）
   - glen-account（账户服务）
   - glen-engine（测试引擎服务）
   - glen-data（数据服务）

4. **启动前端服务**
   - Vite 开发服务器

**执行结果示例：**

```
=========================================
Glen AutoTest Platform - Starting All Services
=========================================

Step 1: Starting Docker middleware services...
[+] up 6/6

Step 2: Checking Docker services status...
NAME             STATUS
glen-mysql       Healthy
glen-redis       Healthy
glen-nacos       Healthy
glen-kafka       Healthy
glen-minio       Healthy
glen-zookeeper   Running

Step 3: Starting backend services...
  - glen-gateway started (PID: 140885)
  - glen-account started (PID: 141054)
  - glen-engine started (PID: 141205)
  - glen-data started (PID: 141419)

Step 4: Starting frontend service...
  - frontend started (PID: 142180)

=========================================
All services started successfully!
=========================================
```

### 4.2 stop-all.sh - 一键停止所有服务

项目提供了一键停止脚本，可以快速停止所有服务。

**使用步骤：**

```bash
# 进入项目目录
cd /opt/yun-glenautotest

# 执行停止脚本
./stop-all.sh
```

**脚本执行过程：**

1. **停止后端服务
   - 终止所有 SpringBoot 进程

2. **停止前端服务
   - 终止 Vite 进程

3. **停止 Docker 中间件**
   - 关闭并移除所有 Docker 容器

**执行结果示例：**

```
=========================================
Glen AutoTest Platform - Stopping All Services
=========================================

Step 1: Stopping backend services...
  - glen-gateway stopped
  - glen-account stopped
  - glen-engine stopped
  - glen-data stopped

Step 2: Stopping frontend service...
  - frontend stopped

Step 3: Stopping Docker middleware services...
[+] down 6/6

=========================================
All services stopped successfully!
=========================================

To restart services, run: ./restart-all.sh
```

---

## 五、故障排查

### 5.1 服务无法启动

1. 检查端口是否被占用：`netstat -tlnp | grep <端口>`
2. 检查 Docker 是否运行：`docker ps`
3. 检查日志文件是否有错误信息
4. 检查内存是否充足：`free -h`

### 5.2 Docker 容器反复重启

```bash
# 查看容器退出代码
docker inspect <container-name> | grep -A 5 ExitCode

# 查看容器详细状态
docker inspect <container-name>

# 查看容器日志
docker logs <container-name>
```

### 5.3 数据持久化问题

Docker volumes 数据存储在 `/var/lib/docker/volumes/` 目录下，无需额外操作即可持久化。

如需备份 MySQL 数据：

```bash
# 备份 MySQL
docker exec glen-mysql mysqldump -uroot -p<密码> <数据库名> > backup.sql

# 恢复 MySQL
docker exec -i glen-mysql mysql -uroot -p<密码> <数据库名> < backup.sql
```

---

## 六、服务访问地址

| 服务 | 访问地址 | 说明 |
|------|---------|------|
| 前端 | http://<服务器IP>:5173 | Vite 开发服务器 |
| Nacos Console | http://<服务器IP>:8848/nacos | 配置中心/用户名: nacos / 密码: nacos |
| MinIO Console | http://<服务器IP>:9001 | 对象存储 / 用户名: admin |
| MySQL | <服务器IP>:3306 | 数据库 |
| Redis | <服务器IP>:6379 | 缓存 |
| Kafka | <服务器IP>:9092 | 消息队列 |

---

**最后更新时间**: 2026-01-17

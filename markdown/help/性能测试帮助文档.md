# 云测 性能测试操作手册

## 目录

- [一、快速开始](#一快速开始)
  - [1.1 创建第一个性能测试用例](#11-创建第一个性能测试用例)
  - [1.2 执行性能测试](#12-执行性能测试)
  - [1.3 查看测试报告](#13-查看测试报告)
- [二、核心概念](#二核心概念)
  - [2.1 什么是性能测试？](#21-什么是性能测试)
  - [2.2 性能测试的工作原理](#22-性能测试的工作原理)
  - [2.3 性能测试的类型](#23-性能测试的类型)
- [三、详细操作指南](#三详细操作指南)
  - [3.1 创建性能测试用例](#31-创建性能测试用例)
  - [3.2 配置线程组参数](#32-配置线程组参数)
  - [3.3 配置采样器参数](#33-配置采样器参数)
  - [3.4 配置断言](#34-配置断言)
  - [3.5 配置参数化](#35-配置参数化)
  - [3.6 执行性能测试](#36-执行性能测试)
  - [3.7 查看测试报告](#37-查看测试报告)
- [四、JMX 压测模式](#四jmx-压测模式)
  - [4.1 JMX 模式概述](#41-jmx-模式概述)
  - [4.2 创建 JMX 脚本](#42-创建-jmx-脚本)
  - [4.3 在平台中使用 JMX 脚本](#43-在平台中使用-jmx-脚本)
  - [4.4 JMX 模式常见问题](#44-jmx-模式常见问题)
- [五、常见问题与排查](#五常见问题与排查)
  - [5.1 如何选择合适的压测类型？](#51-如何选择合适的压测类型)
  - [5.2 如何设置合理的线程数？](#52-如何设置合理的线程数)
  - [5.3 压测执行失败怎么办？](#53-压测执行失败怎么办)
  - [5.4 如何分析测试报告？](#54-如何分析测试报告)
- [六、最佳实践](#六最佳实践)
  - [6.1 线程组配置建议](#61-线程组配置建议)
  - [6.2 断言配置建议](#62-断言配置建议)
  - [6.3 参数化使用建议](#63-参数化使用建议)
  - [6.4 用例设计建议](#64-用例设计建议)

---

## 一、快速开始

### 1.1 创建第一个性能测试用例

**目标：** 创建一个简单的性能测试用例，对接口进行并发压测。

**操作步骤：**

1. **进入用例管理页面**
   - 点击左侧菜单：**性能测试 → 用例管理**
   - 点击 **新建** 按钮

2. **填写用例基本信息**
   - **用例名称**：例如"课程列表接口压测"
   - **所属模块**：选择或创建模块（如"课程接口压测"）
   - **压测类型**：选择 **SIMPLE**（简单模式）
   - **请求方法**：选择 GET
   - **请求路径**：填写 `/courses`
   - **描述**：简要说明测试目的（可选）

3. **选择测试环境**
   - 在 **测试环境** 下拉框中选择已配置的环境
   - 如果没有环境，需要先在 **环境管理** 中创建

4. **配置线程组参数**
   - **线程组名称**：例如"50"
   - **并发数量**：50（表示50个并发用户）
   - **启动时间**：10（秒，10秒内从0增加到50个线程）
   - **循环次数**：1（每个线程执行1次）
   - **是否开启调度器**：关闭
   - 点击 **确定** 保存线程组配置

5. **配置请求参数（可选）**
   - **查询参数**：例如 `page=1&limit=10`
   - **请求头**：根据需要添加（如 Content-Type、鉴权头等）

6. **保存用例**
   - 点击页面底部的 **保存** 按钮
   - 用例创建完成！

### 1.2 执行性能测试

**操作步骤：**

1. 在 **用例管理** 页面，找到刚创建的用例
2. 点击用例右侧的 **执行** 按钮
3. 等待执行完成（执行时间取决于线程组配置）
4. 执行完成后，会自动跳转到测试报告页面

**执行过程中会发生什么？**
- 系统会按照配置的线程数启动并发请求
- 每个线程会按照配置执行请求
- 系统会实时收集响应时间、成功率等指标
- 执行完成后生成测试报告

### 1.3 查看测试报告

**报告包含的信息：**

- ✅ **执行概览**
  - 用例名称、执行时间、总耗时
  - 总请求数、成功请求数、失败请求数
  - 平均响应时间、最小响应时间、最大响应时间
  - P50、P90、P95、P99 响应时间

- ✅ **性能指标**
  - QPS（每秒请求数）
  - 错误率
  - 响应时间分布
  - 吞吐量曲线图

- ✅ **详细数据**
  - 每个请求的详细信息
  - 失败请求的错误信息
  - 断言结果（如果配置了断言）

**如何查看报告：**

1. 执行完成后自动跳转到报告页面
2. 也可以在 **测试报告 → 性能测试** 中查看历史报告
3. 点击报告列表中的用例名称，查看详细报告

---

## 二、核心概念

### 2.1 什么是性能测试？

性能测试是通过模拟大量用户并发访问系统，测试系统在高负载下的性能表现，包括：

- **响应时间**：接口处理请求所需的时间
- **吞吐量**：系统每秒能处理的请求数（QPS）
- **并发能力**：系统能同时处理的并发用户数
- **稳定性**：长时间运行下的性能表现

**性能测试的目的：**

- ✅ 评估系统性能：了解系统在正常负载下的性能表现
- ✅ 发现性能瓶颈：找出系统的性能瓶颈点
- ✅ 容量规划：评估系统能承受的最大负载
- ✅ 性能优化：为性能优化提供数据支持

### 2.2 性能测试的工作原理

**执行流程：**

```
┌─────────────────────────────────────────────────────────────┐
│                 1. 用户配置测试用例                           │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 用例：课程列表接口压测                                │   │
│  │   线程数：50                                          │   │
│  │   启动时间：10秒                                      │   │
│  │   请求路径：/courses                                  │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                  2. 系统启动压测引擎                         │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ • 解析用例配置                                       │   │
│  │ • 初始化线程组                                       │   │
│  │ • 准备请求参数                                       │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                 3. 并发执行请求                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ • 启动线程（按启动时间逐步增加）                      │   │
│  │ • 每个线程发送 HTTP 请求                              │   │
│  │ • 收集响应时间、状态码等数据                          │   │
│  │ • 执行断言验证（如果配置了）                          │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    4. 生成测试报告                             │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ • 统计总请求数、成功数、失败数                        │   │
│  │ • 计算平均响应时间、P95、P99 等                       │   │
│  │ • 生成性能曲线图                                      │   │
│  │ • 记录断言结果                                        │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

**核心概念：**

- **线程（Thread）**：每个线程代表一个虚拟用户，会独立发送请求
- **并发（Concurrency）**：同时运行的线程数，即并发用户数
- **采样（Sample）**：每次 HTTP 请求称为一个采样
- **响应时间（Response Time）**：从发送请求到收到响应的时间
- **吞吐量（Throughput）**：系统每秒处理的请求数（QPS）

### 2.3 性能测试的类型

Glen 性能测试平台支持两种压测模式：

#### 2.3.1 SIMPLE 模式（简单压测）

**特点：**
- ✅ 在平台上直接配置压测参数
- ✅ 配置简单，快速上手
- ✅ 适合单接口压测
- ✅ 支持断言和参数化

**适用场景：**
- 单接口性能测试
- 快速压测验证
- 简单的业务场景

**配置方式：**
- 在平台界面填写请求方法、路径、参数等
- 配置线程组参数（线程数、启动时间等）
- 配置断言和参数化（可选）

#### 2.3.2 JMX 模式（JMX 压测）

**特点：**
- ✅ 使用 JMeter JMX 脚本
- ✅ 支持复杂测试场景
- ✅ 支持多接口编排
- ✅ 支持 CSV 参数化
- ✅ 复用现有 JMeter 脚本

**适用场景：**
- 复杂业务流程压测
- 多接口顺序压测
- 条件判断、循环控制等复杂场景
- 已有 JMeter 脚本复用

**配置方式：**
- 使用 JMeter 创建 JMX 脚本
- 上传 JMX 文件到平台
- 平台自动执行 JMX 脚本

**选择建议：**

| 场景 | 推荐模式 |
|------|---------|
| 单接口压测 | SIMPLE 模式 |
| 快速压测验证 | SIMPLE 模式 |
| 多接口编排 | JMX 模式 |
| 复杂业务场景 | JMX 模式 |
| 已有 JMeter 脚本 | JMX 模式 |

---

## 三、详细操作指南

### 3.1 创建性能测试用例

**操作路径：** 性能测试 → 用例管理 → 新建

**必填字段：**

| 字段 | 说明 | 示例 |
|------|------|------|
| **用例名称** | 测试用例的名称 | "课程列表接口压测" |
| **所属模块** | 用例所属的业务模块 | "课程接口压测" |
| **压测类型** | SIMPLE 或 JMX | SIMPLE（推荐新手使用） |
| **测试环境** | 执行压测的环境 | "花桥学堂测试环境" |

**SIMPLE 模式必填字段：**

| 字段 | 说明 | 示例 |
|------|------|------|
| **请求方法** | HTTP 请求方法 | GET、POST、PUT、DELETE |
| **请求路径** | 接口路径（不含域名） | `/courses` |

**可选字段：**

- **描述**：用例的详细说明
- **查询参数**：URL 查询参数（如 `page=1&limit=10`）
- **请求头**：HTTP 请求头（如 Content-Type、鉴权头）
- **请求体**：POST/PUT 请求的请求体（JSON 格式）

**注意事项：**

- 用例名称要清晰明确，便于后续查找和管理
- 确保测试环境已正确配置（协议、域名、端口）
- SIMPLE 模式适合单接口压测，复杂场景建议使用 JMX 模式

### 3.2 配置线程组参数

**线程组参数说明：**

线程组参数用于控制压测的并发数和执行时间。

| 参数名称 | 字段名 | 说明 | 示例值 |
|---------|--------|------|--------|
| **线程组名称** | `threadGroupName` | 线程组的标识名称 | "50" |
| **并发数量** | `numThreads` | 线程数，即并发用户数 | 50 |
| **启动时间（秒）** | `rampUp` | 从0个线程增加到目标线程数所需的时间 | 10 |
| **循环次数** | `loopCount` | 每个线程执行请求的次数 | 1 |
| **是否开启调度器** | `schedulerEnabled` | 是否启用调度器控制压测时间 | false |
| **持续时间（秒）** | `duration` | 调度器启用后，压测持续的总时间 | 300 |
| **启动延迟（秒）** | `delay` | 调度器启用后，延迟多久才开始执行 | 0 |

**参数详细说明：**

**1. 并发数量（numThreads）**
- **含义**：同时运行的线程数，即并发用户数
- **示例**：50 表示同时有 50 个用户并发请求
- **建议**：根据系统容量逐步增加，不要一开始就设置很大的值

**2. 启动时间（rampUp）**
- **含义**：线程启动的时间，从 0 个线程逐渐增加到目标线程数
- **示例**：50 线程 + 10 秒启动时间 = 每 0.2 秒启动 1 个线程
- **作用**：避免瞬间高并发冲击系统，平滑启动
- **建议**：根据系统承受能力设置，一般设置为 5-30 秒

**3. 循环次数（loopCount）**
- **含义**：每个线程执行请求的次数
- **取值**：
  - `-1`：永久循环（需配合调度器使用）
  - `0`：由持续时间控制（需开启调度器）
  - `>0`：固定次数（如 1 表示每个线程执行 1 次）
- **建议**：快速压测用 1，长时间压测配合调度器使用

**4. 是否开启调度器（schedulerEnabled）**
- **含义**：是否启用调度器来控制压测的精确时间
- **关闭时**：由循环次数控制，每个线程执行指定次数后停止
- **开启时**：由持续时间控制，在指定时间内持续压测
- **建议**：需要精确控制压测时长时开启

**5. 持续时间（duration）**
- **含义**：调度器启用后，压测持续的总时间（秒）
- **生效条件**：仅在 `schedulerEnabled=true` 时生效
- **示例**：300 表示压测持续 5 分钟
- **建议**：根据测试目标设置，一般设置为 60-600 秒

**6. 启动延迟（delay）**
- **含义**：调度器启用后，延迟多久才开始执行压测（秒）
- **生效条件**：仅在 `schedulerEnabled=true` 时生效
- **示例**：5 表示等待 5 秒后才开始压测
- **建议**：一般设置为 0，需要等待系统准备时设置

**配置示例：**

**示例1：快速压测（功能验证）**
```
线程组名称：10
并发数量：10
启动时间：5秒
循环次数：1
是否开启调度器：关闭
```
**说明**：10 秒内启动 10 个线程，每个线程执行 1 次请求后停止。

**示例2：稳定性压测（长时间运行）**
```
线程组名称：50
并发数量：50
启动时间：30秒
循环次数：-1
是否开启调度器：开启
启动延迟：0秒
持续时间：600秒（10分钟）
```
**说明**：30 秒内启动 50 个线程，持续运行 10 分钟。

**示例3：峰值压测（模拟秒杀场景）**
```
线程组名称：200
并发数量：200
启动时间：5秒（快速达到峰值）
循环次数：-1
是否开启调度器：开启
启动延迟：0秒
持续时间：60秒（1分钟峰值）
```
**说明**：5 秒内快速启动 200 个线程，持续压测 1 分钟。

### 3.3 配置采样器参数

**采样器参数说明：**

采样器参数用于配置 HTTP 请求的详细信息。

| 参数名称 | 说明 | 示例 |
|---------|------|------|
| **请求方法** | HTTP 请求方法 | GET、POST、PUT、DELETE |
| **请求路径** | 接口路径（不含域名和协议） | `/courses` |
| **查询参数** | URL 查询参数 | `page=1&limit=10` |
| **请求头** | HTTP 请求头 | `Content-Type: application/json` |
| **请求体** | POST/PUT 请求的请求体 | JSON 格式数据 |
| **请求体类型** | 请求体的格式 | JSON、FORM、XML |

**配置示例：**

**示例1：GET 请求（查询接口）**
```
请求方法：GET
请求路径：/courses
查询参数：page=1&limit=10
请求头：
  - Content-Type: application/json
```

**示例2：POST 请求（创建接口）**
```
请求方法：POST
请求路径：/orders
请求头：
  - Content-Type: application/json
  - Authorization: Bearer token123
请求体：
{
  "courseId": "1001",
  "userId": "2001",
  "price": 299
}
请求体类型：JSON
```

**注意事项：**

- 请求路径不需要包含协议、域名、端口（这些由测试环境提供）
- 查询参数格式：`key1=value1&key2=value2`
- 请求头格式：每行一个，格式为 `key: value`
- JSON 请求体需要是有效的 JSON 格式

### 3.4 配置断言

**断言的作用：**

断言用于验证请求在压力下是否依然业务正确，例如：
- 响应状态码是否为 200
- 响应时间是否小于 500ms
- 响应体中是否包含特定内容

**断言配置说明：**

| 配置项 | 说明 | 可选值 |
|-------|------|--------|
| **断言来源** | 从哪个部分获取数据进行比较 | RESPONSE_CODE、RESPONSE_HEADER、RESPONSE_DATA、RESPONSE_TIME |
| **断言动作** | 比较的方式 | EQUAL、NOT_EQUAL、CONTAIN、NOT_CONTAIN、GREAT_THEN、LESS_THEN |
| **期望值** | 期望的结果值 | 根据断言动作填写 |

**断言来源说明：**

| 断言来源 | 说明 | 示例 |
|---------|------|------|
| **RESPONSE_CODE** | 响应状态码 | 200、404、500 |
| **RESPONSE_HEADER** | 响应头 | Content-Type、Set-Cookie |
| **RESPONSE_DATA** | 响应体内容 | JSON 字符串、HTML 内容 |
| **RESPONSE_TIME** | 响应时间（毫秒） | 500、1000 |

**断言动作说明：**

| 断言动作 | 说明 | 适用来源 | 示例 |
|---------|------|---------|------|
| **EQUAL** | 完全相等 | 所有来源 | 状态码等于 200 |
| **NOT_EQUAL** | 不相等 | 所有来源 | 状态码不等于 500 |
| **CONTAIN** | 包含 | RESPONSE_DATA、RESPONSE_HEADER | 响应体包含 "success" |
| **NOT_CONTAIN** | 不包含 | RESPONSE_DATA、RESPONSE_HEADER | 响应体不包含 "error" |
| **GREAT_THEN** | 大于 | RESPONSE_TIME | 响应时间大于 1000ms |
| **LESS_THEN** | 小于 | RESPONSE_TIME | 响应时间小于 500ms |

**配置示例：**

**示例1：验证状态码**
```
断言来源：RESPONSE_CODE
断言动作：EQUAL
期望值：200
```
**说明**：验证响应状态码必须为 200。

**示例2：验证响应时间**
```
断言来源：RESPONSE_TIME
断言动作：LESS_THEN
期望值：500
```
**说明**：验证响应时间必须小于 500 毫秒。

**示例3：验证响应体内容**
```
断言来源：RESPONSE_DATA
断言动作：CONTAIN
期望值：{"success":true}
```
**说明**：验证响应体中包含 `{"success":true}`。

**示例4：组合断言（多个断言）**
```
断言1：
  断言来源：RESPONSE_CODE
  断言动作：EQUAL
  期望值：200

断言2：
  断言来源：RESPONSE_TIME
  断言动作：LESS_THEN
  期望值：500

断言3：
  断言来源：RESPONSE_DATA
  断言动作：CONTAIN
  期望值："success"
```
**说明**：同时验证状态码、响应时间和响应体内容。

**断言结果查看：**

- 在测试报告中可以查看每个请求的断言结果
- 断言失败的请求会在报告中标记为失败
- 可以查看断言失败的具体原因（实际值 vs 期望值）

### 3.5 配置参数化

**参数化的作用：**

参数化允许使用不同的数据执行相同的请求，例如：
- 使用不同的用户 ID 测试登录接口
- 使用不同的商品 ID 测试下单接口
- 避免重复使用相同数据导致缓存影响

**参数化配置说明：**

| 配置项 | 说明 | 示例 |
|-------|------|------|
| **参数名称** | 变量的名称 | `userId`、`courseId` |
| **参数来源** | 数据的来源 | CSV 文件、固定列表、随机数 |
| **参数值** | 具体的参数值 | 根据参数来源填写 |

**参数来源类型：**

**1. CSV 文件（推荐）**
- **说明**：从 CSV 文件中读取数据
- **适用场景**：大量测试数据、需要循环使用数据
- **配置方式**：
  - 上传 CSV 文件到平台
  - 配置 CSV 文件的列名作为变量名
  - 在请求中使用 `${变量名}` 引用

**2. 固定列表**
- **说明**：从固定的列表中依次取值
- **适用场景**：少量测试数据、简单的参数化需求
- **配置方式**：
  - 在平台上直接填写参数值列表
  - 系统会依次使用列表中的值

**3. 随机数**
- **说明**：生成随机数作为参数值
- **适用场景**：不需要固定数据、测试数据唯一性
- **配置方式**：
  - 配置随机数的范围和格式
  - 系统自动生成随机值

**CSV 参数化配置示例：**

**步骤1：准备 CSV 文件**
```csv
userId,courseId,price
1001,2001,299
1002,2002,399
1003,2003,499
```

**步骤2：上传 CSV 文件**
- 在用例编辑页面，找到"参数化配置"区域
- 点击"上传 CSV 文件"按钮
- 选择 CSV 文件上传

**步骤3：配置参数映射**
```
CSV 列名：userId → 变量名：userId
CSV 列名：courseId → 变量名：courseId
CSV 列名：price → 变量名：price
```

**步骤4：在请求中使用变量**
```
请求体：
{
  "userId": "${userId}",
  "courseId": "${courseId}",
  "price": ${price}
}
```

**固定列表参数化示例：**

```
参数名称：userId
参数来源：固定列表
参数值：1001,1002,1003,1004,1005
```

在请求中使用：`${userId}`

系统会依次使用：1001 → 1002 → 1003 → 1004 → 1005

**注意事项：**

- CSV 文件第一行必须是列名（表头）
- CSV 文件使用逗号（`,`）分隔
- 变量名在请求中使用 `${变量名}` 格式引用
- 如果数据用完，系统会根据配置决定是循环使用还是停止

### 3.6 执行性能测试

**操作步骤：**

1. **进入用例管理页面**
   - 点击左侧菜单：**性能测试 → 用例管理**

2. **找到要执行的用例**
   - 在用例列表中找到目标用例
   - 可以使用搜索框按名称搜索

3. **执行用例**
   - 点击用例右侧的 **执行** 按钮
   - 系统会弹出确认对话框
   - 点击 **确认** 开始执行

4. **等待执行完成**
   - 执行过程中，可以在页面上看到执行状态
   - 执行完成后，会自动跳转到测试报告页面

**执行状态说明：**

- **执行中**：用例正在执行，请耐心等待
- **执行成功**：压测执行完成，可以查看报告
- **执行失败**：执行过程中出现错误，查看错误信息

**注意事项：**

- 执行过程中不要关闭浏览器标签页
- 执行时间取决于线程组配置（线程数、持续时间等）
- 如果执行时间过长，可能是线程数过多或持续时间设置过长
- 执行失败时，查看错误信息，检查配置是否正确

### 3.7 查看测试报告

**报告入口：**

1. **执行完成后自动跳转**
   - 用例执行完成后，会自动跳转到报告详情页面

2. **从报告列表进入**
   - 点击左侧菜单：**测试报告 → 性能测试**
   - 在报告列表中找到目标报告
   - 点击用例名称进入详情

**报告内容说明：**

**1. 执行概览**
- 用例名称、执行时间、总耗时
- 总请求数、成功请求数、失败请求数
- 成功率、错误率

**2. 性能指标**
- **平均响应时间**：所有请求的平均响应时间
- **最小响应时间**：最快的请求响应时间
- **最大响应时间**：最慢的请求响应时间
- **P50 响应时间**：50% 的请求响应时间小于此值
- **P90 响应时间**：90% 的请求响应时间小于此值
- **P95 响应时间**：95% 的请求响应时间小于此值
- **P99 响应时间**：99% 的请求响应时间小于此值
- **QPS**：每秒请求数（吞吐量）

**3. 性能曲线图**
- 响应时间曲线：展示响应时间随时间的变化
- 吞吐量曲线：展示 QPS 随时间的变化
- 错误率曲线：展示错误率随时间的变化

**4. 详细数据**
- 每个请求的详细信息（响应时间、状态码等）
- 失败请求的错误信息
- 断言结果（如果配置了断言）

**如何分析报告：**

1. **查看整体指标**
   - 成功率是否达到预期（一般要求 > 99%）
   - 平均响应时间是否在可接受范围内
   - P95、P99 响应时间是否符合 SLA 要求

2. **查看性能曲线**
   - 响应时间曲线是否平稳（如果波动大，可能存在性能问题）
   - 吞吐量是否达到预期
   - 错误率是否在可接受范围内

3. **查看失败请求**
   - 如果失败率较高，查看失败请求的错误信息
   - 分析失败原因（超时、服务器错误、断言失败等）

4. **对比历史报告**
   - 与历史报告对比，评估性能变化
   - 如果性能下降，需要进一步分析原因

---

## 四、JMX 压测模式

### 4.1 JMX 模式概述

**JMX 模式特点：**

- ✅ **支持复杂测试场景**：多接口编排、条件判断、循环控制
- ✅ **复用现有 JMeter 脚本**：直接使用已有的 JMX 文件
- ✅ **CSV 参数化支持**：自动处理 JMX 脚本中的 CSV 数据文件配置
- ✅ **完整 JMeter 功能**：支持 JMeter 的所有功能特性

**JMX 模式与 SIMPLE 模式对比：**

| 特性 | SIMPLE 模式 | JMX 模式 |
|------|------------|---------|
| 配置方式 | 平台界面配置 | 上传 JMX 脚本 |
| 适用场景 | 单接口压测 | 复杂场景压测 |
| 环境配置 | 需要选择环境 | JMX 脚本中已配置 |
| CSV 参数化 | 支持 | 支持（自动处理） |
| 多接口编排 | 不支持 | 支持 |
| 学习成本 | 低 | 中等（需要了解 JMeter） |

**选择建议：**

- **使用 SIMPLE 模式**：单接口压测、快速压测验证
- **使用 JMX 模式**：复杂业务流程压测、多接口编排、已有 JMeter 脚本复用

### 4.2 创建 JMX 脚本

**使用 JMeter 创建脚本：**

1. **下载并安装 JMeter**
   - 访问 Apache JMeter 官网：https://jmeter.apache.org/
   - 下载 JMeter 5.5 或更高版本
   - 解压到本地目录

2. **启动 JMeter GUI**
   ```bash
   # Windows
   jmeter.bat
   
   # Linux/Mac
   ./jmeter.sh
   ```

3. **创建测试计划**
   - 打开 JMeter，会自动创建一个空的测试计划
   - 右键 `Test Plan` → `Add` → `Threads (Users)` → `Thread Group`
   - 配置线程组参数（线程数、Ramp-Up、循环次数等）

4. **添加 HTTP 请求**
   - 右键 `Thread Group` → `Add` → `Sampler` → `HTTP Request`
   - 配置请求参数（服务器名称/IP、端口、路径、方法等）

5. **添加断言（可选）**
   - 右键 `HTTP Request` → `Add` → `Assertions` → `Response Assertion`
   - 配置断言规则

6. **保存为 JMX 文件**
   - `File` → `Save Test Plan As...`
   - 保存为 `.jmx` 文件

**简单的 JMX 脚本示例：**

创建一个压测课程列表接口的 JMX 脚本：

**测试计划结构：**
```
Test Plan (课程列表接口压测)
└── Thread Group
    ├── HTTP Request (课程列表)
    │   └── Response Assertion (状态码=200)
    └── Summary Report (监听器)
```

**Thread Group 配置：**
- **Threads (Users)**: 50
- **Ramp-Up Period**: 10
- **Loop Count**: 1

**HTTP Request 配置：**
- **Server Name**: localhost
- **Port**: 3000
- **Path**: /courses
- **Method**: GET
- **Parameters**: page=1&limit=10

**CSV 参数化配置（可选）：**

如果需要在 JMX 脚本中使用 CSV 参数化：

1. **创建 CSV 文件**
   ```csv
   userId,courseId
   1001,2001
   1002,2002
   1003,2003
   ```

2. **在 JMeter 中添加 CSV 数据文件配置**
   - 右键 `Thread Group` → `Add` → `Config Element` → `CSV Data Set Config`
   - 配置：
     - **Filename**: `/path/to/your/data.csv`（或相对路径）
     - **Variable Names**: `userId,courseId`
     - **Delimiter**: `,`（逗号）
     - **Recycle on EOF**: True（循环使用）
     - **Stop thread on EOF**: False

3. **在 HTTP 请求中使用变量**
   - 路径或参数中使用 `${userId}`、`${courseId}` 引用变量

> **注意**：上传 JMX 脚本到平台时，CSV 文件需要与 JMX 文件一起上传到 MinIO。系统会自动处理 CSV 文件的路径关联。

### 4.3 在平台中使用 JMX 脚本

**操作步骤：**

1. **创建压测用例**
   - 进入 `性能测试` → `用例管理`
   - 点击 `+` 按钮创建新用例

2. **选择压测类型**
   - 在 `选择压测类型` 下拉框中选择 **JMX**

3. **上传 JMX 文件**
   - 点击 `上传 JMX 脚本` 区域的按钮
   - 选择本地 `.jmx` 文件
   - 文件会自动上传到 MinIO 对象存储
   - 上传成功后，按钮显示为 `已上传`

4. **填写用例信息**
   - **用例名称**：例如 `课程列表接口压测（JMX）`
   - **用例描述**：描述压测目标和场景

5. **保存用例**
   - 点击保存，JMX 脚本的 URL 会自动保存到数据库中

> **注意**：
> - JMX 模式下不需要选择环境（环境配置在 JMX 脚本中）
> - 不需要配置请求方法、路径等（已在 JMX 脚本中配置）
> - 线程组配置也在 JMX 脚本中，不需要在平台上配置

**JMX 脚本的 CSV 参数化支持：**

如果 JMX 脚本中使用了 CSV 参数化：

1. **在 JMeter 中配置 CSV Data Set Config**
   - CSV 文件路径使用相对路径（相对于 JMX 文件位置）
   - 例如：`data.csv` 或 `./data.csv`

2. **上传 CSV 文件（如需要）**
   - 如果需要更新 CSV 数据，可以通过文件管理功能上传
   - CSV 文件会上传到 MinIO，系统会自动关联

3. **系统自动处理**
   - 执行压测时，系统会自动解析 JMX 脚本中的 CSV 配置
   - 自动下载 CSV 文件并与 JMX 脚本关联
   - 无需手动配置 CSV 文件路径

**执行 JMX 压测：**

1. **选择用例**
   - 在用例列表中找到要执行的 JMX 压测用例

2. **点击执行**
   - 点击 `执行` 按钮
   - 系统会自动：
     - 从 MinIO 下载 JMX 文件
     - 加载测试计划树
     - 处理 CSV 参数化（如有）
     - 添加结果收集器
     - 启动 JMeter 引擎执行压测

3. **查看报告**
   - 压测执行完成后，在 `测试报告` 中查看结果
   - 报告格式与 SIMPLE 模式相同

### 4.4 JMX 模式常见问题

**问题1：JMX 文件上传失败**

**可能原因：**
- 文件大小超过限制
- 文件格式不正确（必须是 `.jmx` 文件）
- MinIO 服务未启动

**解决方案：**
- 检查文件大小和格式
- 确认 MinIO 服务正常运行
- 查看浏览器控制台错误信息

**问题2：执行时找不到 CSV 文件**

**可能原因：**
- CSV 文件未上传到 MinIO
- JMX 脚本中的 CSV 路径配置不正确

**解决方案：**
- 确保 CSV 文件与 JMX 脚本一起上传
- 检查 JMX 脚本中 CSV Data Set Config 的路径配置
- 使用相对路径而不是绝对路径

**问题3：压测执行失败**

**可能原因：**
- JMX 脚本语法错误
- 服务器地址或端口配置错误
- 缺少必要的组件或插件

**解决方案：**
- 在 JMeter GUI 中测试脚本是否能正常运行
- 检查 JMX 脚本中的服务器配置
- 查看后端日志获取详细错误信息

---

## 五、常见问题与排查

### 5.1 如何选择合适的压测类型？

**问题：** 不知道应该选择 SIMPLE 模式还是 JMX 模式。

**选择建议：**

| 场景 | 推荐模式 | 原因 |
|------|---------|------|
| 单接口压测 | SIMPLE 模式 | 配置简单，快速上手 |
| 快速压测验证 | SIMPLE 模式 | 不需要创建脚本 |
| 多接口顺序压测 | JMX 模式 | SIMPLE 模式不支持 |
| 复杂业务场景 | JMX 模式 | 需要条件判断、循环等 |
| 已有 JMeter 脚本 | JMX 模式 | 直接复用 |

**建议：**
- 新手用户优先使用 SIMPLE 模式
- 复杂场景或已有 JMeter 脚本时使用 JMX 模式

### 5.2 如何设置合理的线程数？

**问题：** 不知道应该设置多少线程数。

**设置建议：**

1. **从小开始，逐步增加**
   - 第一次压测：10 个线程
   - 如果系统正常，增加到 50 个线程
   - 继续增加到 100、200 等，直到找到系统瓶颈

2. **参考系统容量**
   - 如果系统 QPS 目标是 1000，可以设置 100-200 个线程
   - 如果系统容量较小，不要设置过大的线程数

3. **考虑业务场景**
   - 正常负载：50-100 个线程
   - 峰值负载：200-500 个线程
   - 极限测试：500+ 个线程

**注意事项：**
- 不要一开始就设置很大的线程数，可能导致系统崩溃
- 根据测试报告逐步调整，找到系统的最佳并发数

### 5.3 压测执行失败怎么办？

**问题：** 压测执行失败，不知道原因。

**排查步骤：**

1. **查看错误信息**
   - 在测试报告中查看失败请求的错误信息
   - 常见错误：连接超时、服务器错误、网络错误

2. **检查配置**
   - 检查测试环境是否正确配置
   - 检查请求路径、参数是否正确
   - 检查线程组配置是否合理

3. **检查系统状态**
   - 检查被压测的系统是否正常运行
   - 检查网络连接是否正常
   - 检查服务器资源（CPU、内存）是否充足

4. **逐步排查**
   - 先用少量线程（如 10 个）测试，确认基本功能正常
   - 逐步增加线程数，找到失败的原因

**常见失败原因：**

- **连接超时**：服务器响应慢或网络问题
- **服务器错误**：被压测系统出现问题
- **配置错误**：请求路径、参数配置错误
- **资源不足**：服务器资源（CPU、内存）不足

### 5.4 如何分析测试报告？

**问题：** 不知道如何从测试报告中获取有用信息。

**分析步骤：**

1. **查看整体指标**
   - 成功率是否达到预期（一般要求 > 99%）
   - 平均响应时间是否在可接受范围内
   - P95、P99 响应时间是否符合 SLA 要求

2. **查看性能曲线**
   - 响应时间曲线是否平稳（如果波动大，可能存在性能问题）
   - 吞吐量是否达到预期
   - 错误率是否在可接受范围内

3. **查看失败请求**
   - 如果失败率较高，查看失败请求的错误信息
   - 分析失败原因（超时、服务器错误、断言失败等）

4. **对比历史报告**
   - 与历史报告对比，评估性能变化
   - 如果性能下降，需要进一步分析原因

**关键指标说明：**

- **成功率**：成功请求数 / 总请求数，一般要求 > 99%
- **平均响应时间**：所有请求的平均响应时间
- **P95 响应时间**：95% 的请求响应时间小于此值，常用 SLA 指标
- **P99 响应时间**：99% 的请求响应时间小于此值，更严格的 SLA 指标
- **QPS**：每秒请求数，反映系统吞吐量

---

## 六、最佳实践

### 6.1 线程组配置建议

**配置原则：**

1. **启动时间设置**
   - 避免瞬间高并发：设置合理的启动时间（5-30 秒）
   - 根据系统承受能力调整：系统承受能力强可以设置较短的启动时间

2. **持续时间设置**
   - 功能验证：60-300 秒（1-5 分钟）
   - 稳定性测试：600-3600 秒（10-60 分钟）
   - 极限测试：根据测试目标设置

3. **循环次数设置**
   - 快速压测：1 次
   - 长时间压测：配合调度器使用（循环次数设为 -1）

**推荐配置示例：**

| 场景 | 线程数 | 启动时间 | 循环次数 | 调度器 | 持续时间 |
|------|--------|---------|---------|--------|---------|
| 快速验证 | 10 | 5秒 | 1 | 关闭 | - |
| 正常负载 | 50 | 10秒 | -1 | 开启 | 300秒 |
| 峰值测试 | 200 | 5秒 | -1 | 开启 | 60秒 |
| 稳定性测试 | 100 | 30秒 | -1 | 开启 | 1800秒 |

### 6.2 断言配置建议

**配置原则：**

1. **必配置断言**
   - 响应状态码：验证请求是否成功（状态码 = 200）
   - 响应时间：验证性能是否达标（响应时间 < 阈值）

2. **可选断言**
   - 响应体内容：验证业务逻辑是否正确
   - 响应头：验证特定响应头是否存在

3. **断言阈值设置**
   - 根据业务 SLA 设置合理的阈值
   - 一般要求：P95 响应时间 < 500ms，P99 响应时间 < 1000ms

**推荐断言配置：**

```
断言1：响应状态码 = 200（必配）
断言2：响应时间 < 500ms（必配）
断言3：响应体包含 "success"（可选，根据业务需求）
```

### 6.3 参数化使用建议

**使用场景：**

1. **避免缓存影响**
   - 使用不同的参数值，避免系统缓存影响测试结果

2. **模拟真实场景**
   - 使用真实的业务数据，更贴近实际使用场景

3. **数据驱动测试**
   - 使用 CSV 文件管理大量测试数据

**使用建议：**

- **少量数据**：使用固定列表参数化
- **大量数据**：使用 CSV 文件参数化
- **随机数据**：使用随机数参数化
- **数据循环**：如果数据用完，建议循环使用（避免测试中断）

### 6.4 用例设计建议

**设计原则：**

1. **用例名称清晰**
   - 使用有意义的名称，便于后续查找和管理
   - 示例：`课程列表接口压测`、`下单接口压测`

2. **模块化管理**
   - 按业务模块组织用例（如"课程接口压测"、"订单接口压测"）
   - 便于管理和维护

3. **逐步增加压力**
   - 从小压力开始，逐步增加
   - 找到系统的最佳并发数和性能瓶颈

4. **定期执行**
   - 定期执行性能测试，监控系统性能变化
   - 版本发布前后执行，防止性能回退

**用例设计示例：**

```
模块：课程接口压测
├── 用例1：课程列表接口压测（10线程，快速验证）
├── 用例2：课程列表接口压测（50线程，正常负载）
├── 用例3：课程列表接口压测（200线程，峰值测试）
└── 用例4：课程详情接口压测（50线程，正常负载）
```

---

**文档版本：** v1.0  
**最后更新：** 2026-01-21

# CSV å‚æ•°åŒ–å·¥ä½œåŸç†è¯¦è§£

## ä¸€ã€CSV æ–‡ä»¶æ ¼å¼è¯´æ˜

### 1.1 æ–‡ä»¶ç»“æ„

**æ˜¯çš„ï¼Œæ‚¨çš„ç†è§£å®Œå…¨æ­£ç¡®ï¼**

CSV æ–‡ä»¶æ ¼å¼ï¼š
- **ç¬¬ä¸€è¡Œï¼ˆè¡¨å¤´ï¼‰**ï¼šè¡¨ç¤º **å˜é‡åï¼ˆKeyï¼‰**ï¼Œä¹Ÿå°±æ˜¯åœ¨è¯·æ±‚ä¸­ä½¿ç”¨çš„å˜é‡åç§°
- **ç¬¬äºŒè¡Œå¼€å§‹**ï¼šè¡¨ç¤º **å˜é‡å€¼ï¼ˆValueï¼‰**ï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡è¯·æ±‚ä½¿ç”¨çš„å…·ä½“æ•°æ®
- **æ¯ä¸€è¡Œ**ï¼šä»£è¡¨ä¸€ç»„å‚æ•°å€¼ï¼Œç”¨äºä¸€æ¬¡è¯·æ±‚

### 1.2 ç¤ºä¾‹æ–‡ä»¶è§£æ

ä»¥ `å‚æ•°åŒ–ç¤ºä¾‹-ç™»å½•ç”¨æˆ·.csv` ä¸ºä¾‹ï¼š

```csv
username,password
zhangsan,123456
lisi,123456
wangwu,123456
```

**è§£æè¯´æ˜ï¼š**
- ç¬¬1è¡Œ `username,password`ï¼šå®šä¹‰äº†ä¸¤ä¸ªå˜é‡å
  - `username` â†’ ç”¨æˆ·åå˜é‡
  - `password` â†’ å¯†ç å˜é‡
- ç¬¬2è¡Œ `zhangsan,123456`ï¼šç¬¬ä¸€ç»„æ•°æ®
  - `username = "zhangsan"`
  - `password = "123456"`
- ç¬¬3è¡Œ `lisi,123456`ï¼šç¬¬äºŒç»„æ•°æ®
  - `username = "lisi"`
  - `password = "123456"`
- ç¬¬4è¡Œ `wangwu,123456`ï¼šç¬¬ä¸‰ç»„æ•°æ®
  - `username = "wangwu"`
  - `password = "123456"`

**æ˜¯çš„ï¼Œè¿™è¡¨ç¤ºä¸åŒè´¦å·çš„ä¼ å‚ï¼** æ¯ä¸€è¡Œä»£è¡¨ä¸€ä¸ªä¸åŒçš„è´¦å·ï¼Œç³»ç»Ÿä¼šä¾æ¬¡ä½¿ç”¨è¿™äº›è´¦å·è¿›è¡Œæµ‹è¯•ã€‚

---

## äºŒã€åº•å±‚å·¥ä½œåŸç†

### 2.1 æ•´ä½“æµç¨‹

```
ç”¨æˆ·ä¸Šä¼ CSVæ–‡ä»¶ 
  â†“
å‰ç«¯é…ç½®å‚æ•°æ˜ å°„ï¼ˆå˜é‡åï¼‰
  â†“
åç«¯ä¿å­˜é…ç½®åˆ°æ•°æ®åº“
  â†“
æ‰§è¡Œæµ‹è¯•æ—¶ï¼š
  1. è¯»å–CSVé…ç½®
  2. åˆ›å»ºJMeter CSVDataSetç»„ä»¶
  3. é…ç½®CSVè¯»å–è§„åˆ™
  4. JMeterè‡ªåŠ¨è¯»å–CSVæ–‡ä»¶
  5. æ¯æ¬¡è¯·æ±‚å‰ï¼ŒJMeterä»CSVè¯»å–ä¸€è¡Œæ•°æ®
  6. å°†æ•°æ®èµ‹å€¼ç»™å˜é‡
  7. åœ¨HTTPè¯·æ±‚ä¸­ä½¿ç”¨ ${å˜é‡å} æ›¿æ¢ä¸ºå®é™…å€¼
  8. å‘é€è¯·æ±‚
  9. ä¸‹æ¬¡è¯·æ±‚æ—¶ï¼Œè¯»å–ä¸‹ä¸€è¡Œæ•°æ®ï¼ˆå¾ªç¯ï¼‰
```

### 2.2 ä»£ç å®ç°æµç¨‹

#### æ­¥éª¤1ï¼šå‰ç«¯é…ç½®ï¼ˆç”¨æˆ·æ“ä½œï¼‰

ç”¨æˆ·åœ¨æ€§èƒ½æµ‹è¯•ç”¨ä¾‹ç¼–è¾‘é¡µé¢ï¼š
1. ä¸Šä¼  CSV æ–‡ä»¶ï¼ˆå¦‚ï¼š`å‚æ•°åŒ–ç¤ºä¾‹-ç™»å½•ç”¨æˆ·.csv`ï¼‰
2. é…ç½®å‚æ•°æ˜ å°„ï¼š
   - **åç§°**ï¼š`ç™»å½•ç”¨æˆ·æ•°æ®`
   - **å˜é‡åç§°**ï¼š`username,password`ï¼ˆå¯¹åº”CSVç¬¬ä¸€è¡Œçš„åˆ—åï¼‰
   - **åˆ†éš”ç¬¦**ï¼š`,`ï¼ˆé€—å·ï¼‰
   - **æ˜¯å¦å¿½ç•¥é¦–è¡Œ**ï¼š`true`ï¼ˆè·³è¿‡ç¬¬ä¸€è¡Œï¼Œå› ä¸ºç¬¬ä¸€è¡Œæ˜¯å˜é‡åï¼‰
   - **å¾ªç¯è¯»å–**ï¼š`true`ï¼ˆæ•°æ®ç”¨å®Œåé‡æ–°å¼€å§‹ï¼‰

#### æ­¥éª¤2ï¼šåç«¯ä¿å­˜é…ç½®

å‰ç«¯å°†é…ç½®ä¿å­˜ä¸º JSON æ ¼å¼ï¼Œå­˜å‚¨åˆ°æ•°æ®åº“çš„ `relation` å­—æ®µï¼š

```json
[
  {
    "name": "ç™»å½•ç”¨æˆ·æ•°æ®",
    "remoteFilePath": "/files/csv/ç™»å½•ç”¨æˆ·.csv",
    "sourceType": "csv",
    "delimiter": ",",
    "ignoreFirstLine": true,
    "recycle": true,
    "variableNames": "username,password"
  }
]
```

#### æ­¥éª¤3ï¼šæ‰§è¡Œæµ‹è¯•æ—¶åˆ›å»º CSVDataSet

**ä»£ç ä½ç½®**ï¼š`StressSimpleEngine.java` çš„ `createCsvDataSetList()` æ–¹æ³•

```java
// 1. ä»æ•°æ®åº“è¯»å–é…ç½®
List<CSVDataFileDTO> csvDataFileDTOS = JsonUtil.json2List(
    stressCaseDO.getRelation(), 
    CSVDataFileDTO.class
);

// 2. ä¸ºæ¯ä¸ªCSVæ–‡ä»¶åˆ›å»ºJMeterçš„CSVDataSetç»„ä»¶
for(CSVDataFileDTO csvDataFileDTO : csvDataFileDTOS){
    CSVDataSet csvDataSet = new CSVDataSet();
    
    // è®¾ç½®CSVæ–‡ä»¶è·¯å¾„ï¼ˆä»è¿œç¨‹æ–‡ä»¶æœåŠ¡å™¨ä¸‹è½½åˆ°æœ¬åœ°ä¸´æ—¶æ–‡ä»¶ï¼‰
    csvDataSet.setProperty("filename", 
        fileService.copyRemoteFileToLocalTempFile(
            csvDataFileDTO.getRemoteFilePath()
        )
    );
    
    // è®¾ç½®å˜é‡åï¼ˆå¯¹åº”CSVç¬¬ä¸€è¡Œçš„åˆ—åï¼‰
    csvDataSet.setProperty("variableNames", 
        csvDataFileDTO.getVariableNames()  // "username,password"
    );
    
    // è®¾ç½®åˆ†éš”ç¬¦
    csvDataSet.setProperty("delimiter", ",");
    
    // è®¾ç½®æ˜¯å¦å¿½ç•¥ç¬¬ä¸€è¡Œ
    csvDataSet.setProperty("ignoreFirstLine", true);
    
    // è®¾ç½®æ˜¯å¦å¾ªç¯è¯»å–
    csvDataSet.setProperty("recycle", true);
    
    // è®¾ç½®æ–‡ä»¶ç¼–ç 
    csvDataSet.setProperty("fileEncoding", "UTF-8");
    
    // æ·»åŠ åˆ°æµ‹è¯•è®¡åˆ’
    csvDataSetList.add(csvDataSet);
}
```

#### æ­¥éª¤4ï¼šJMeter å¦‚ä½•è¯»å– CSV æ•°æ®

**JMeter çš„ CSVDataSet ç»„ä»¶å·¥ä½œåŸç†ï¼š**

1. **åˆå§‹åŒ–é˜¶æ®µ**ï¼š
   - JMeter æ‰“å¼€ CSV æ–‡ä»¶
   - å¦‚æœ `ignoreFirstLine = true`ï¼Œè·³è¿‡ç¬¬ä¸€è¡Œï¼ˆå˜é‡åè¡Œï¼‰
   - æ ¹æ® `variableNames` åˆ›å»ºå˜é‡ï¼š`username`ã€`password`

2. **æ¯æ¬¡è¯·æ±‚å‰ï¼ˆiterationStartï¼‰**ï¼š
   - JMeter ä» CSV æ–‡ä»¶è¯»å–**ä¸‹ä¸€è¡Œ**æ•°æ®
   - æŒ‰åˆ†éš”ç¬¦ï¼ˆ`,`ï¼‰åˆ†å‰²æ•°æ®
   - å°†æ•°æ®èµ‹å€¼ç»™å˜é‡ï¼š
     ```
     ç¬¬1æ¬¡è¯·æ±‚ï¼šusername = "zhangsan", password = "123456"
     ç¬¬2æ¬¡è¯·æ±‚ï¼šusername = "lisi", password = "123456"
     ç¬¬3æ¬¡è¯·æ±‚ï¼šusername = "wangwu", password = "123456"
     ```

3. **å˜é‡æ›¿æ¢**ï¼š
   - åœ¨ HTTP è¯·æ±‚çš„ URLã€è¯·æ±‚å¤´ã€è¯·æ±‚ä½“ä¸­ï¼Œä½¿ç”¨ `${å˜é‡å}` æ ¼å¼
   - JMeter è‡ªåŠ¨å°† `${username}` æ›¿æ¢ä¸ºå®é™…å€¼
   - JMeter è‡ªåŠ¨å°† `${password}` æ›¿æ¢ä¸ºå®é™…å€¼

4. **å¾ªç¯æœºåˆ¶**ï¼š
   - å¦‚æœ `recycle = true`ï¼šæ•°æ®ç”¨å®Œåï¼Œä»ç¬¬ä¸€è¡Œé‡æ–°å¼€å§‹
   - å¦‚æœ `recycle = false`ï¼šæ•°æ®ç”¨å®Œåï¼Œçº¿ç¨‹åœæ­¢

---

## ä¸‰ã€å‚æ•°æ˜ å°„æœºåˆ¶

### 3.1 é¡¹ç›®å¦‚ä½•çŸ¥é“å“ªä¸ªå‚æ•°å¯¹åº”å“ªä¸ªå‚æ•°ï¼Ÿ

**ç­”æ¡ˆï¼šé€šè¿‡ `variableNames` å­—æ®µè¿›è¡Œæ˜ å°„ï¼**

**æ˜ å°„è¿‡ç¨‹ï¼š**

1. **CSV æ–‡ä»¶ç¬¬ä¸€è¡Œ**ï¼ˆå˜é‡åå®šä¹‰ï¼‰ï¼š
   ```csv
   username,password
   ```

2. **å‰ç«¯é…ç½®çš„ `variableNames`**ï¼š
   ```
   username,password
   ```

3. **JMeter çš„æ˜ å°„é€»è¾‘**ï¼š
   - JMeter è¯»å– CSV ç¬¬ä¸€è¡Œï¼ˆæˆ–ä½¿ç”¨ `variableNames` é…ç½®ï¼‰
   - æŒ‰é¡ºåºåˆ›å»ºå˜é‡ï¼š
     - ç¬¬1åˆ— â†’ `username` å˜é‡
     - ç¬¬2åˆ— â†’ `password` å˜é‡
   - è¯»å–æ•°æ®è¡Œæ—¶ï¼ŒæŒ‰é¡ºåºèµ‹å€¼ï¼š
     ```csv
     zhangsan,123456
     ```
     - ç¬¬1åˆ— `zhangsan` â†’ èµ‹å€¼ç»™ `username`
     - ç¬¬2åˆ— `123456` â†’ èµ‹å€¼ç»™ `password`

4. **åœ¨è¯·æ±‚ä¸­ä½¿ç”¨**ï¼š
   ```json
   {
     "username": "${username}",    // JMeteræ›¿æ¢ä¸º "zhangsan"
     "password": "${password}"     // JMeteræ›¿æ¢ä¸º "123456"
   }
   ```

### 3.2 å˜é‡åé¡ºåºå¿…é¡»ä¸€è‡´

**é‡è¦ï¼šCSV åˆ—çš„é¡ºåºå¿…é¡»ä¸ `variableNames` çš„é¡ºåºä¸€è‡´ï¼**

âœ… **æ­£ç¡®ç¤ºä¾‹ï¼š**
```csv
username,password
zhangsan,123456
```
`variableNames = "username,password"` â†’ ç¬¬1åˆ—æ˜ å°„åˆ° `username`ï¼Œç¬¬2åˆ—æ˜ å°„åˆ° `password`

âŒ **é”™è¯¯ç¤ºä¾‹ï¼š**
```csv
password,username
123456,zhangsan
```
`variableNames = "username,password"` â†’ ç¬¬1åˆ—ä¼šæ˜ å°„åˆ° `username`ï¼ˆé”™è¯¯ï¼åº”è¯¥æ˜¯ `password`ï¼‰

---

## å››ã€æ•°æ®å¾ªç¯æœºåˆ¶

### 4.1 å¦‚ä½•ç»§ç»­ä¼ ä¸‹ä¸€ä¸ªå‚æ•°ï¼Ÿ

**JMeter è‡ªåŠ¨ç®¡ç†ï¼**

**å·¥ä½œæµç¨‹ï¼š**

1. **ç¬¬1æ¬¡è¯·æ±‚**ï¼š
   - JMeter è¯»å– CSV ç¬¬2è¡Œï¼ˆç¬¬1è¡Œæ˜¯å˜é‡åï¼‰
   - `username = "zhangsan"`, `password = "123456"`
   - å‘é€è¯·æ±‚

2. **ç¬¬2æ¬¡è¯·æ±‚**ï¼š
   - JMeter **è‡ªåŠ¨**è¯»å– CSV ç¬¬3è¡Œ
   - `username = "lisi"`, `password = "123456"`
   - å‘é€è¯·æ±‚

3. **ç¬¬3æ¬¡è¯·æ±‚**ï¼š
   - JMeter **è‡ªåŠ¨**è¯»å– CSV ç¬¬4è¡Œ
   - `username = "wangwu"`, `password = "123456"`
   - å‘é€è¯·æ±‚

4. **ç¬¬11æ¬¡è¯·æ±‚**ï¼ˆå‡è®¾åªæœ‰10è¡Œæ•°æ®ï¼‰ï¼š
   - å¦‚æœ `recycle = true`ï¼šä»ç¬¬2è¡Œé‡æ–°å¼€å§‹
   - å¦‚æœ `recycle = false`ï¼šçº¿ç¨‹åœæ­¢

### 4.2 å¤šçº¿ç¨‹å¹¶å‘æ—¶çš„æ•°æ®åˆ†é…

**`shareMode = "shareMode.all"`**ï¼ˆä»£ç ä¸­è®¾ç½®ï¼‰

- **æ‰€æœ‰çº¿ç¨‹å…±äº«åŒä¸€ä¸ª CSV æ–‡ä»¶**
- **æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹è¯»å–è¡Œ**
- **JMeter å†…éƒ¨ä½¿ç”¨æ–‡ä»¶æŒ‡é’ˆç®¡ç†è¯»å–ä½ç½®**

**ç¤ºä¾‹ï¼š3ä¸ªçº¿ç¨‹ï¼Œ10è¡Œæ•°æ®**

```
çº¿ç¨‹1ï¼šè¯»å–ç¬¬2è¡Œ â†’ ç¬¬5è¡Œ â†’ ç¬¬8è¡Œ â†’ ç¬¬11è¡Œï¼ˆå¾ªç¯åˆ°ç¬¬2è¡Œï¼‰
çº¿ç¨‹2ï¼šè¯»å–ç¬¬3è¡Œ â†’ ç¬¬6è¡Œ â†’ ç¬¬9è¡Œ â†’ ç¬¬12è¡Œï¼ˆå¾ªç¯åˆ°ç¬¬3è¡Œï¼‰
çº¿ç¨‹3ï¼šè¯»å–ç¬¬4è¡Œ â†’ ç¬¬7è¡Œ â†’ ç¬¬10è¡Œ â†’ ç¬¬13è¡Œï¼ˆå¾ªç¯åˆ°ç¬¬4è¡Œï¼‰
```

---

## äº”ã€å®Œæ•´ç¤ºä¾‹

### 5.1 CSV æ–‡ä»¶

```csv
username,password
zhangsan,123456
lisi,123456
wangwu,123456
```

### 5.2 å‰ç«¯é…ç½®

```json
{
  "name": "ç™»å½•ç”¨æˆ·æ•°æ®",
  "variableNames": "username,password",
  "delimiter": ",",
  "ignoreFirstLine": true,
  "recycle": true
}
```

### 5.3 HTTP è¯·æ±‚ä½“

```json
{
  "username": "${username}",
  "password": "${password}"
}
```

### 5.4 å®é™…å‘é€çš„è¯·æ±‚

**ç¬¬1æ¬¡è¯·æ±‚ï¼š**
```json
{
  "username": "zhangsan",
  "password": "123456"
}
```

**ç¬¬2æ¬¡è¯·æ±‚ï¼š**
```json
{
  "username": "lisi",
  "password": "123456"
}
```

**ç¬¬3æ¬¡è¯·æ±‚ï¼š**
```json
{
  "username": "wangwu",
  "password": "123456"
}
```

**ç¬¬4æ¬¡è¯·æ±‚ï¼ˆå¾ªç¯ï¼‰ï¼š**
```json
{
  "username": "zhangsan",  // é‡æ–°ä»ç¬¬2è¡Œå¼€å§‹
  "password": "123456"
}
```

---

## å…­ã€å…³é”®ä»£ç ä½ç½®

### 6.1 åç«¯ä»£ç 

1. **CSV é…ç½® DTO**ï¼š
   - `backend/glen-engine/src/main/java/com/glen/autotest/dto/stress/CSVDataFileDTO.java`

2. **åˆ›å»º CSVDataSet**ï¼š
   - `backend/glen-engine/src/main/java/com/glen/autotest/service/stress/core/StressSimpleEngine.java`
   - æ–¹æ³•ï¼š`createCsvDataSetList()`ï¼ˆç¬¬119-153è¡Œï¼‰

3. **JMX æ¨¡å¼å¤„ç†**ï¼š
   - `backend/glen-engine/src/main/java/com/glen/autotest/service/stress/core/StressJmxEngine.java`
   - æ–¹æ³•ï¼š`parseParamFilesToScript()`ï¼ˆç¬¬99-139è¡Œï¼‰

### 6.2 JMeter ç»„ä»¶

- **CSVDataSet**ï¼š`org.apache.jmeter.config.CSVDataSet`
- JMeter å®˜æ–¹æ–‡æ¡£ï¼šCSV Data Set Config ç»„ä»¶

---

## ä¸ƒã€æ€»ç»“

### 7.1 æ ¸å¿ƒè¦ç‚¹

1. **CSV ç¬¬ä¸€è¡Œ = å˜é‡åï¼ˆKeyï¼‰**
2. **CSV ç¬¬äºŒè¡Œå¼€å§‹ = å˜é‡å€¼ï¼ˆValueï¼‰**
3. **æ¯ä¸€è¡Œ = ä¸€ç»„å‚æ•° = ä¸€æ¬¡è¯·æ±‚çš„æ•°æ®**
4. **`variableNames` é…ç½® = å‘Šè¯‰ç³»ç»Ÿ CSV åˆ—åå¯¹åº”çš„å˜é‡å**
5. **JMeter è‡ªåŠ¨ç®¡ç†æ•°æ®è¯»å–å’Œå¾ªç¯**
6. **ä½¿ç”¨ `${å˜é‡å}` åœ¨è¯·æ±‚ä¸­å¼•ç”¨å˜é‡**

### 7.2 å·¥ä½œæµç¨‹

```
CSVæ–‡ä»¶ â†’ ä¸Šä¼ åˆ°æœåŠ¡å™¨ â†’ é…ç½®å˜é‡æ˜ å°„ â†’ 
æ‰§è¡Œæµ‹è¯•æ—¶åˆ›å»ºCSVDataSet â†’ JMeterè¯»å–CSV â†’ 
æ¯æ¬¡è¯·æ±‚å‰è¯»å–ä¸€è¡Œ â†’ èµ‹å€¼ç»™å˜é‡ â†’ 
æ›¿æ¢è¯·æ±‚ä¸­çš„${å˜é‡å} â†’ å‘é€è¯·æ±‚ â†’ 
ç»§ç»­ä¸‹ä¸€è¡Œï¼ˆå¾ªç¯ï¼‰
```

### 7.3 æ³¨æ„äº‹é¡¹

1. âœ… CSV ç¬¬ä¸€è¡Œå¿…é¡»æ˜¯å˜é‡å
2. âœ… `variableNames` é¡ºåºå¿…é¡»ä¸ CSV åˆ—é¡ºåºä¸€è‡´
3. âœ… ä½¿ç”¨ `${å˜é‡å}` æ ¼å¼å¼•ç”¨å˜é‡
4. âœ… `ignoreFirstLine = true` æ—¶ï¼Œä¼šè·³è¿‡ç¬¬ä¸€è¡Œ
5. âœ… `recycle = true` æ—¶ï¼Œæ•°æ®ç”¨å®Œåä¼šå¾ªç¯ä½¿ç”¨

---

**å¸Œæœ›è¿™ä¸ªæ–‡æ¡£èƒ½å¸®åŠ©æ‚¨ç†è§£ CSV å‚æ•°åŒ–çš„å®Œæ•´å·¥ä½œåŸç†ï¼** ğŸ‰

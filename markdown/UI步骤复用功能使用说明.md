# UI 步骤复用功能使用说明

## 功能概述

UI 步骤复用功能允许在测试用例中引用已定义的步骤，避免重复配置相同的操作，提高测试用例的可维护性和编写效率。

## 核心概念

### 步骤类型

- **LOCAL（本地步骤）**：直接定义的常规步骤，包含完整的操作配置
- **REFER（引用步骤）**：引用其他已存在的本地步骤，复用其所有配置

### 字段说明

- `stepType`: 步骤类型，值为 `LOCAL` 或 `REFER`
- `referStepId`: 当 `stepType=REFER` 时，指向被引用步骤的 ID

## 使用场景

### 场景1：用户登录流程复用

```yaml
用例1：用户登录流程
  步骤1: 打开登录页 (LOCAL)
  步骤2: 输入用户名 (LOCAL)
  步骤3: 输入密码 (LOCAL)
  步骤4: 点击登录按钮 (LOCAL)
  步骤5: 验证登录成功 (LOCAL)

用例2：查看个人信息
  步骤1: 引用"用户登录流程"的全部步骤 (REFER)
  步骤2: 点击个人中心 (LOCAL)
  步骤3: 验证信息显示 (LOCAL)

用例3：修改个人资料
  步骤1: 引用"用户登录流程"的全部步骤 (REFER)
  步骤2: 点击编辑按钮 (LOCAL)
  步骤3: 修改资料 (LOCAL)
  步骤4: 保存修改 (LOCAL)
```

### 场景2：常用操作步骤复用

```yaml
基础步骤库：
  步骤A: 打开浏览器并访问首页 (LOCAL)
  步骤B: 等待页面加载完成 (LOCAL)
  步骤C: 最大化浏览器窗口 (LOCAL)
  
测试用例：
  步骤1: 引用步骤A (REFER)
  步骤2: 引用步骤B (REFER)
  步骤3: 引用步骤C (REFER)
  步骤4: 执行具体测试操作 (LOCAL)
```

## 操作指南

### 1. 创建本地步骤

1. 进入 **UI自动化 → 用例管理**
2. 新增或编辑用例
3. 添加步骤，选择 **步骤类型** 为 **"本地步骤"**
4. 配置完整的操作信息（操作类型、定位方式、值等）
5. 保存步骤

### 2. 创建引用步骤

1. 在用例中添加新步骤
2. 选择 **步骤类型** 为 **"引用步骤"**
3. 从下拉列表中选择要引用的步骤
4. （可选）自定义步骤名称
5. 保存步骤

**重要提示：**
- 只能引用 **本地步骤**（stepType=LOCAL）
- 不能引用其他引用步骤（防止嵌套引用）
- 引用步骤将使用被引用步骤的所有配置
- 可以为引用步骤自定义名称，但操作内容保持一致

### 3. 前端界面说明

在步骤编辑弹窗中：

```
┌─────────────────────────────────────┐
│ 步骤类型：                          │
│  ○ 本地步骤  ● 引用步骤              │
├─────────────────────────────────────┤
│ 引用步骤：                          │
│  ┌───────────────────────────────┐  │
│  │ 步骤2 - 输入用户名          ▼ │  │
│  └───────────────────────────────┘  │
├─────────────────────────────────────┤
│ 提示：引用步骤将使用被引用步骤的    │
│ 所有配置（操作类型、定位方式、      │
│ 值等），但可以自定义步骤名称。      │
└─────────────────────────────────────┘
```

## 技术实现

### 后端实现

#### 1. 数据库表结构

```sql
ALTER TABLE glen_ui.ui_case_step 
ADD COLUMN step_type VARCHAR(20) DEFAULT 'LOCAL' COMMENT '步骤类型 LOCAL/REFER',
ADD COLUMN refer_step_id BIGINT NULL COMMENT '引用步骤ID';
```

#### 2. 引用解析逻辑

在执行测试用例时，系统会自动解析引用步骤：

```java
if(stepType == "REFER") {
    // 1. 查找被引用的步骤
    UiCaseStepDO referStep = findStepById(referStepId);
    
    // 2. 检测循环引用
    checkCircularReference(referStepId, visitedIds);
    
    // 3. 递归解析（如果被引用步骤也是引用类型）
    while(referStep.stepType == "REFER") {
        referStep = resolveReferStep(referStep.referStepId);
    }
    
    // 4. 使用被引用步骤的配置执行
    execute(referStep);
}
```

#### 3. 循环引用检测

系统自动检测并防止循环引用：

```
步骤A 引用 步骤B
步骤B 引用 步骤C
步骤C 引用 步骤A  ❌ 检测到循环引用，抛出异常
```

### 前端实现

#### 1. TypeScript 类型定义

```typescript
export interface IUICaseStep {
  id: number
  name: string
  stepType: string // 'LOCAL' | 'REFER'
  referStepId: number | null
  // ... 其他字段
}
```

#### 2. UI 组件

- 使用 `Radio.Group` 选择步骤类型
- 使用 `Select` 选择引用步骤
- 动态显示/隐藏配置项（引用步骤不显示操作配置）

## 功能优势

### 1. 提高效率
- **减少重复配置**：常用步骤配置一次，多处引用
- **快速构建用例**：组合已有步骤快速构建新用例
- **降低维护成本**：修改一处，所有引用自动更新

### 2. 保证一致性
- **操作统一**：所有引用步骤使用相同的配置
- **减少错误**：避免手动重复配置导致的差异

### 3. 便于管理
- **步骤库管理**：建立常用步骤库
- **版本控制**：修改被引用步骤时，所有用例同步更新

## 最佳实践

### 1. 建立步骤库

创建专门的"步骤库用例"，存放常用的基础步骤：

```yaml
步骤库用例：通用操作步骤
  步骤1: 打开浏览器
  步骤2: 最大化窗口
  步骤3: 用户登录
  步骤4: 退出登录
  步骤5: 刷新页面
  步骤6: 等待2秒
```

### 2. 命名规范

- **本地步骤**：使用描述性名称，如"输入用户名"、"点击登录按钮"
- **引用步骤**：可添加前缀标识，如"[引用]用户登录"

### 3. 引用粒度

- **粗粒度**：引用完整的业务流程（如完整登录流程）
- **细粒度**：引用单个原子操作（如打开浏览器）

根据实际需求选择合适的粒度。

### 4. 避免过度引用

- 不要为了引用而引用
- 只引用真正会重复使用的步骤
- 简单步骤可直接定义，无需引用

## 注意事项

### 1. 只能引用本地步骤
❌ 不支持：引用步骤 → 引用步骤（嵌套引用）  
✅ 支持：引用步骤 → 本地步骤

### 2. 循环引用检测
系统会自动检测循环引用并抛出异常：
```
步骤A 引用 步骤B
步骤B 引用 步骤A
→ 错误：检测到循环引用
```

### 3. 被引用步骤修改
修改被引用的步骤后，所有引用该步骤的用例都会受到影响。
**建议**：修改前评估影响范围。

### 4. 步骤删除
删除被引用的步骤前，请确保没有其他步骤在引用它。

## 错误处理

### 常见错误及解决方案

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| `引用步骤的referStepId不能为空` | 选择了引用类型但未选择具体步骤 | 选择要引用的步骤 |
| `引用的步骤不存在，stepId: xxx` | 被引用的步骤已被删除 | 修改为本地步骤或选择其他步骤 |
| `检测到循环引用，步骤ID: xxx` | 步骤之间存在循环引用 | 检查引用关系，打破循环 |

## 示例用例

### 示例：电商网站测试

```yaml
# 步骤库用例
用例名称：基础操作步骤库
步骤1: 打开电商首页 (LOCAL)
  - 操作类型：打开窗口
  - 值：http://shop.example.com
  
步骤2: 用户登录 (LOCAL)
  - 操作类型：组合操作
  - 包含：输入用户名 → 输入密码 → 点击登录
  
步骤3: 搜索商品 (LOCAL)
  - 操作类型：键盘输入
  - 定位：ID=search-input
  
# 实际测试用例
用例名称：商品购买流程测试
步骤1: 引用"打开电商首页" (REFER, referStepId=步骤1的ID)
步骤2: 引用"用户登录" (REFER, referStepId=步骤2的ID)
步骤3: 引用"搜索商品" (REFER, referStepId=步骤3的ID)
步骤4: 点击第一个商品 (LOCAL)
步骤5: 加入购物车 (LOCAL)
步骤6: 提交订单 (LOCAL)
步骤7: 验证订单成功 (LOCAL)
```

## 总结

UI 步骤复用功能通过引用机制实现了测试步骤的重用，大大提高了测试用例的编写效率和可维护性。合理使用该功能，可以：

✅ 减少重复配置工作  
✅ 提高用例编写速度  
✅ 保证操作一致性  
✅ 降低维护成本  
✅ 建立可复用的步骤库  

---

**版本信息**
- 功能版本：v1.0
- 文档更新日期：2026-01-21
- 作者：Glen AutoTest Team

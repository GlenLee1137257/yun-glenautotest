# 接口自动化 - 接口库改造说明

## 📋 改造概述

本次改造将"接口管理"从单纯的"接口文档库"升级为**可选的接口配置源**，参考 UI 自动化的元素库设计，实现了**接口库与用例管理的可选关联**。

## 🎯 改造目标

解决用户提出的问题：
- ❌ **改造前**：接口管理只是接口文档，与用例管理完全独立，功能价值有限
- ✅ **改造后**：接口管理可作为接口配置源，用例步骤可选择"从接口库选择"，自动同步最新配置

## 🔧 技术实现

### 1. 数据库变更

**文件：** `/home/hinkad/yun-glenautotest/Mysql/add_api_library_support.sql`

为 `api_case_step` 表增加两个字段：
- `api_id`：关联的接口ID（来自接口管理）
- `use_api_library`：是否使用接口库（0=手动配置，1=从接口库选择）

```sql
ALTER TABLE `api_case_step`
ADD COLUMN `api_id` bigint NULL DEFAULT NULL COMMENT '关联的接口ID（来自接口管理）' 
AFTER `case_id`;

ALTER TABLE `api_case_step`
ADD COLUMN `use_api_library` tinyint UNSIGNED NULL DEFAULT 0 COMMENT '是否使用接口库（0=手动配置，1=从接口库选择）'
AFTER `api_id`;
```

### 2. 后端改造

#### 2.1 数据模型更新

**文件：**
- `backend/glen-common/src/main/java/com/glen/autotest/dto/ApiCaseStepDTO.java`
- `backend/glen-engine/src/main/java/com/glen/autotest/model/ApiCaseStepDO.java`

增加字段：
```java
@Schema(description = "关联的接口ID（来自接口管理）")
@TableField("api_id")
private Long apiId;

@Schema(description = "是否使用接口库（0=手动配置，1=从接口库选择）")
@TableField("use_api_library")
private Boolean useApiLibrary;
```

#### 2.2 执行引擎改造

**文件：** `backend/glen-engine/src/main/java/com/glen/autotest/service/api/core/ApiExecuteEngine.java`

新增 `resolveApiLibrary()` 方法，参考 UI 自动化的 `resolveElementLibrary()` 实现：

```java
private void resolveApiLibrary(ApiCaseStepDO step) {
    // 如果未启用接口库或没有关联接口ID，则不处理
    if (step.getApiId() == null || step.getUseApiLibrary() == null || !step.getUseApiLibrary()) {
        return;
    }

    try {
        // 查询接口库中的接口信息
        ApiDO apiDO = apiMapper.selectOne(...);

        if (apiDO != null) {
            // 接口存在，同步最新的接口信息
            step.setMethod(apiDO.getMethod());
            step.setPath(apiDO.getPath());
            step.setEnvironmentId(apiDO.getEnvironmentId());
            // ... 同步其他字段
        } else {
            // 接口不存在（已从接口库中删除），使用步骤中的备用信息
            log.warn("接口库中的接口不存在，将使用备用接口信息");
        }
    } catch (Exception e) {
        // 查询失败，使用步骤中的备用信息，不中断执行
        log.error("从接口库同步信息失败", e);
    }
}
```

在 `doExecute()` 方法中调用：
```java
ApiCaseStepDO step = stepList.get(0);

// 从接口库同步信息（如果启用）
resolveApiLibrary(step);

// ... 继续执行
```

### 3. 前端改造

#### 3.1 类型定义更新

**文件：** `frontend/src/types/apis/api-case.ts`

```typescript
export type IApiCaseStep = Omit<IApi, 'moduleId'> & {
  caseId: number
  num: number
  assertion: string
  relation: string
  apiId: number | null          // 新增
  useApiLibrary: boolean         // 新增
}
```

#### 3.2 步骤编辑组件改造

**文件：** `frontend/src/components/NewOrEdit/ApiCaseStep.vue`

**新增功能：**

1. **接口库选择开关**
```vue
<Switch
  v-model:checked="selectedStep.useApiLibrary"
  checked-children="从接口库选择"
  un-checked-children="手动配置"
/>
```

2. **接口选择器**
```vue
<Button
  v-if="selectedStep.useApiLibrary"
  type="primary"
  size="small"
  @click="openApiSelector"
>
  选择接口
</Button>
```

3. **接口选择器 Modal**
- 展示所有接口列表
- 点击接口后自动填充接口信息
- 自动反序列化请求参数到编辑器

4. **字段锁定**
- 当 `useApiLibrary=true` 时，接口基本信息字段（请求方法、接口地址、环境）被禁用
- 用户无法手动修改，确保与接口库同步

#### 3.3 表单组件改造

**文件：**
- `frontend/src/components/FormItem/FormItemMethod.vue`
- `frontend/src/components/FormItem/FormItemEnvironment.vue`

增加 `disabled` 属性支持：
```vue
defineProps<{ disabled?: boolean }>()

<Select :disabled="disabled">
  <!-- ... -->
</Select>
```

### 4. 帮助文档更新

**文件：** `markdown/help/接口自动化帮助文档.md`

**更新内容：**

1. **1.3 配置用例步骤** - 新增"选择接口配置方式"章节
   - 方式1：从接口库选择（推荐⭐）
   - 方式2：手动配置

2. **1.1.4 接口管理的使用建议** - 更新接口管理的定位
   - 方式1：作为接口文档库（独立使用）
   - 方式2：作为接口配置源（与用例关联）

## 📊 功能对比

| 特性 | 改造前 | 改造后 |
|------|--------|--------|
| **接口管理定位** | 仅作为接口文档 | 接口文档 + 接口配置源 |
| **与用例关联** | 完全独立 | 可选关联 |
| **接口信息同步** | 不支持 | 支持自动同步 |
| **配置灵活性** | 仅手动配置 | 手动配置 + 接口库选择 |
| **维护成本** | 每个用例独立维护 | 可统一管理或独立维护 |

## 🎨 用户体验

### 使用场景1：从接口库选择

1. 在用例步骤编辑页面，切换开关为"从接口库选择"
2. 点击"选择接口"按钮
3. 在弹出的接口选择器中选择接口
4. 系统自动填充接口信息，字段被锁定
5. 保存步骤

**优势：**
- ✅ 接口信息自动同步，无需手动维护
- ✅ 多个用例使用同一接口时，只需在接口库中修改一次
- ✅ 避免手动配置时的拼写错误

### 使用场景2：手动配置

1. 在用例步骤编辑页面，保持开关为"手动配置"
2. 手动填写接口信息
3. 保存步骤

**优势：**
- ✅ 灵活性高，可以自定义配置
- ✅ 适合临时测试或接口不稳定的场景

## 🔄 数据同步逻辑

参考 UI 自动化的元素库设计：

```
用例执行时：
├─ 检查 useApiLibrary 标志
├─ 如果为 true
│  ├─ 查询接口库中的接口信息（通过 apiId）
│  ├─ 如果接口存在
│  │  └─ 使用接口库中的最新信息
│  └─ 如果接口不存在（已删除）
│     └─ 使用步骤中保存的备用信息
└─ 如果为 false
   └─ 使用步骤中的手动配置信息
```

## 📝 部署步骤

### 1. 执行数据库脚本

```bash
mysql -u root -p < /home/hinkad/yun-glenautotest/Mysql/add_api_library_support.sql
```

### 2. 编译后端

```bash
cd /home/hinkad/yun-glenautotest/backend/glen-common
mvn clean install

cd /home/hinkad/yun-glenautotest/backend/glen-engine
mvn clean spring-boot:run
```

### 3. 启动前端

```bash
cd /home/hinkad/yun-glenautotest/frontend
npm run dev
```

## ✅ 测试验证

### 测试场景1：从接口库选择

1. 在"接口管理"中创建一个接口（例如：登录接口）
2. 在"用例管理"中创建一个用例
3. 添加步骤，选择"从接口库选择"
4. 选择刚才创建的接口
5. 验证接口信息是否自动填充
6. 保存步骤，执行用例
7. 修改接口库中的接口信息（例如：修改路径）
8. 重新执行用例，验证是否使用最新的接口信息

### 测试场景2：手动配置

1. 在"用例管理"中创建一个用例
2. 添加步骤，保持"手动配置"
3. 手动填写接口信息
4. 保存步骤，执行用例
5. 验证用例是否正常执行

### 测试场景3：切换配置方式

1. 创建一个步骤，选择"从接口库选择"
2. 选择一个接口，保存
3. 重新编辑步骤，切换为"手动配置"
4. 验证字段是否解锁，可以手动修改
5. 再次切换回"从接口库选择"
6. 验证字段是否重新锁定

## 🎉 总结

本次改造成功解决了用户提出的"接口管理功能价值有限"的问题，通过参考 UI 自动化的元素库设计，实现了：

1. ✅ **接口库与用例管理的可选关联**
2. ✅ **接口信息的自动同步**
3. ✅ **灵活的配置方式（接口库选择 + 手动配置）**
4. ✅ **降低维护成本，提高测试效率**

同时保持了系统的灵活性，用户可以根据实际需求选择使用接口库或手动配置，满足不同场景的测试需求。
